# 🚀 クイックスタートガイド - 初心者向け

**所要時間**: 5分
**対象者**: プログラミング初心者、サーバー管理初心者

---

## 📚 このドキュメントの読み方

このプロジェクトには複数のドキュメントがあります。**最初はこれだけ読めばOK**です。

```
📖 読む順番:

1. ✅ このファイル (クイックスタートガイド_初心者向け.md) ← 今ココ
   ↓
2. 日常運用マニュアル.md (作成したら)
   ↓
3. 必要に応じて他のドキュメントを参照
```

**他のドキュメント** (困ったときに見る):
- `README_開発者向け.md` - 技術的な詳細
- `デプロイ前チェックリスト.md` - デプロイ時の詳細手順
- `運用手順書_v260119.md` - 既存の運用手順
- `SQLiteマイグレーション_実装完了報告.md` - 技術解説

---

## 🎯 このサービスは何？

**清算くん** は、飲み会の割り勘を自動計算するLINE botです。

### どう動いているの？

```
LINEアプリ
    ↓
LINE Messaging API (LINEのサーバー)
    ↓
あなたのRaspberry Pi (自宅のサーバー)
    ↓
清算くんbot (Node.jsアプリ)
```

**重要**: Raspberry Piが止まると、botも止まります。

---

## 🖥️ サーバーの場所と接続方法

### Raspberry Piに接続する

```bash
# ローカルネットワークから
ssh sk283@raspberrypi.local

# または IPアドレス
ssh sk283@192.168.x.x
```

**パスワード**: Raspberry Pi設定時に決めたパスワード

### 接続できない？
1. Raspberry Piの電源は入っていますか？（LEDランプ確認）
2. 同じWi-Fiに接続していますか？
3. IPアドレスが変わっていませんか？ → ルーターの管理画面で確認

---

## ⚙️ サーバーの基本操作

Raspberry Piに接続したら、以下のコマンドで操作します。

### サーバーの状態確認

```bash
# サーバーが動いているか確認
pm2 status

# 出力例:
# ┌─────┬──────────────┬─────────┬─────────┐
# │ id  │ name         │ status  │ cpu     │
# ├─────┼──────────────┼─────────┼─────────┤
# │ 0   │ tatekaezamurai│ online  │ 0%      │
# └─────┴──────────────┴─────────┴─────────┘

# ✅ status が "online" なら正常
# ❌ status が "stopped" or "errored" なら問題あり
```

### ログを見る（何が起きているか確認）

```bash
# リアルタイムでログを表示（Ctrl+Cで終了）
pm2 logs

# 最新100行だけ表示
pm2 logs --lines 100

# エラーだけ表示
pm2 logs --err
```

### サーバーの操作

```bash
# サーバーを再起動（最もよく使う）
pm2 restart all

# サーバーを停止
pm2 stop all

# サーバーを起動
pm2 start all

# 自動起動の設定を保存
pm2 save
```

---

## 🔍 何か問題が起きたら

### チェックリスト（上から順番に）

#### 1️⃣ サーバーは動いている？
```bash
pm2 status
```
→ `online` なら OK、`stopped` なら `pm2 start all`

#### 2️⃣ エラーが出ている？
```bash
pm2 logs --lines 50 --err
```
→ エラーメッセージをコピーして、後述の「よくあるエラー」を確認

#### 3️⃣ ディスク容量は大丈夫？
```bash
df -h
```
→ `/` の `Use%` が 90% 超えていたら危険

#### 4️⃣ メモリは足りている？
```bash
free -h
```
→ `available` が 100MB 以下なら再起動を検討

---

## 🐛 よくあるエラーと解決方法

### エラー1: サーバーが起動しない

**症状**:
```
pm2 status で "errored" と表示される
```

**解決方法**:
```bash
# ログでエラー内容を確認
pm2 logs --err --lines 100

# よくある原因と対処:
# - ポート3000が使われている → 他のプロセスを確認
# - 環境変数がない → .env ファイルを確認
# - データベースエラー → 後述の「データベース関連エラー」参照
```

### エラー2: LINEで反応しない

**症状**:
```
LINEでメッセージを送っても何も返ってこない
```

**確認ポイント**:
```bash
# 1. サーバーは動いている？
pm2 status

# 2. Webhookは届いている？
pm2 logs --lines 50
# 「📨 イベントを受信」というログが出るはず

# 3. 出ない場合 → ngrokが止まっている可能性
# ngrokを再起動してWebhook URLをLINE Developersで更新
```

### エラー3: データベース関連エラー

**症状**:
```
❌ スキーマ初期化エラー
ENOENT: no such file or directory
```

**解決方法**:
```bash
cd ~/tatekaezamurai-bot/server

# ビルドし直す
npm run build

# サーバー再起動
pm2 restart all
```

### エラー4: 「清算くん」が古いコードで動いている

**症状**:
```
GitHubで最新コードをpushしたのに、動作が変わらない
```

**解決方法**:
```bash
cd ~/tatekaezamurai-bot

# 最新コードを取得
git pull origin main

# ビルドし直す
cd server
npm run build

# サーバー再起動
pm2 restart all

# ログで確認
pm2 logs --lines 20
```

---

## 📦 データのバックアップ

### 自動バックアップ

**毎日午前3時に自動でバックアップされます。**

バックアップの場所:
```bash
~/tatekaezamurai-bot/server/dist/data/backups/
```

確認方法:
```bash
ls -lh ~/tatekaezamurai-bot/server/dist/data/backups/

# 出力例:
# sessions_2026-01-22.json
# sessions_2026-01-21.json
# sessions_2026-01-20.json
```

### 手動バックアップ

```bash
cd ~/tatekaezamurai-bot/server

# 全データをエクスポート
npm run export-json

# 統計情報を表示
npm run export-json:stats
```

### バックアップからの復元

**データが消えた！という場合**:

```bash
# 1. バックアップファイルを確認
ls ~/tatekaezamurai-bot/server/dist/data/backups/

# 2. 最新のバックアップをコピー
cp ~/tatekaezamurai-bot/server/dist/data/backups/sessions_2026-01-22.json \
   ~/tatekaezamurai-bot/server/src/data/sessions.json

# 3. サーバー再起動（自動的にSQLiteに移行される）
pm2 restart all
```

---

## 🔐 セキュリティの基本

### 1. 環境変数ファイル (.env)

**絶対に外部に漏らしてはいけないファイル**:
```bash
~/tatekaezamurai-bot/server/.env
```

このファイルには:
- LINE Channel Secret
- LINE Channel Access Token

が含まれています。**GitHubにはpushしないこと**（.gitignoreで除外済み）

### 2. ngrokの認証トークン

ngrok使用時は、無料プランでもアカウント登録が必要です。
認証トークンも秘密情報として扱ってください。

### 3. SSH接続

Raspberry Piへの接続は、可能であれば：
- SSHキー認証を使用
- デフォルトポート(22)を変更
- fail2banでブルートフォース攻撃対策

（これは上級者向け。最初は気にしなくてOK）

---

## 🌐 ngrokの使い方（外部公開）

### ngrokとは？

自宅のRaspberry Piを、インターネットから使えるようにするツールです。

```
LINE → ngrok → Raspberry Pi
```

### 基本的な使い方

```bash
# 別のターミナルで実行（Raspberry Piにssh接続）
ngrok http 3000
```

出力例:
```
Forwarding  https://abc123.ngrok.io -> http://localhost:3000
```

この `https://abc123.ngrok.io/webhook` をLINE DevelopersのWebhook URLに設定します。

### 注意点

- **ngrokは終了すると、URLが変わります**
- 毎回LINE DevelopersでWebhook URLを更新する必要あり
- 有料プラン ($8/月) なら固定URLが使える

---

## 📝 よくある質問（FAQ）

### Q1. Raspberry Piを再起動したら、botが動かなくなった

**A**: pm2が自動起動設定されていない可能性があります。

```bash
# 手動で起動
cd ~/tatekaezamurai-bot/server
pm2 start dist/index.js --name tatekaezamurai

# 自動起動設定を保存
pm2 save
pm2 startup
# ↑ 表示されたコマンドをコピペして実行
```

### Q2. コードを変更したのに、反映されない

**A**: TypeScriptはビルドが必要です。

```bash
cd ~/tatekaezamurai-bot/server
npm run build    # TypeScript → JavaScriptに変換
pm2 restart all  # 再起動
```

### Q3. データベースファイルはどこ？

**A**:
```bash
~/tatekaezamurai-bot/server/dist/data/database.db
```

このファイルを直接編集しないでください。壊れる可能性があります。

### Q4. ログファイルはどこ？

**A**: pm2が管理しています。
```bash
~/.pm2/logs/tatekaezamurai-out.log  # 通常ログ
~/.pm2/logs/tatekaezamurai-error.log # エラーログ
```

`pm2 logs` コマンドで見るのが簡単です。

### Q5. 「清算くん」を停止したい（メンテナンス中など）

**A**:
```bash
# 停止
pm2 stop all

# 再開
pm2 start all
```

停止中は、LINEで何を送っても反応しません。

---

## 🎓 次のステップ

ここまで読めば、基本的な運用ができます！

### さらに学ぶには

1. **日常運用マニュアル.md** - 定期的にやるべきこと
2. **README_開発者向け.md** - 技術的な詳細
3. **Node.js公式ドキュメント** - プログラミングを学ぶ
4. **SQLite公式ドキュメント** - データベースを学ぶ

### 便利なツール

- **VS Code** - コード編集
- **TablePlus / DB Browser for SQLite** - データベース閲覧
- **Postman** - APIテスト

---

## 📞 困ったときの連絡先

1. **GitHubのIssue**: https://github.com/sakaguchiii/tatekaezamurai-bot/issues
2. **既存ドキュメントを検索**: `grep "キーワード" *.md`
3. **ログを確認**: `pm2 logs --lines 200`

**ログを共有する際は、環境変数（LINE Secretなど）が含まれていないか確認してください！**

---

## ✅ チェックリスト（印刷して使う）

日常運用のチェックリスト:

- [ ] 毎日: `pm2 status` でサーバーの状態確認
- [ ] 毎週: `pm2 logs --lines 100` でエラーチェック
- [ ] 毎月: バックアップファイルの確認
- [ ] コード変更時: `npm run build` → `pm2 restart all`
- [ ] Raspberry Pi再起動時: `pm2 status` で自動起動を確認

---

**このガイドで基本はマスターです！わからないことがあれば、他のドキュメントを参照してください。** 🎉
