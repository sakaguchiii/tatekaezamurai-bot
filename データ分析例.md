# ãƒ‡ãƒ¼ã‚¿åˆ†æä¾‹ - SQLiteãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ã§ãã‚‹ã“ã¨

## ğŸ” é–‹ç™ºè€…å‘ã‘ï¼šå®Ÿç”¨çš„ãªSQLã‚¯ã‚¨ãƒªé›†

### 1. åŸºæœ¬çµ±è¨ˆ

#### å…¨ä½“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ
```sql
-- ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã€ç·æ”¯æ‰•ã„é¡ã€å¹³å‡æ”¯æ‰•ã„é¡
SELECT
  COUNT(*) as total_sessions,
  COUNT(CASE WHEN status = 'active' THEN 1 END) as active_sessions,
  COUNT(CASE WHEN status = 'settled' THEN 1 END) as settled_sessions
FROM sessions;
```

#### æœˆåˆ¥ã®åˆ©ç”¨çµ±è¨ˆ
```sql
-- æœˆã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã¨ç·æ”¯æ‰•ã„é¡
SELECT
  strftime('%Y-%m', created_at) as month,
  COUNT(*) as session_count,
  COUNT(DISTINCT group_id) as unique_groups
FROM sessions
WHERE created_at >= date('now', '-6 months')
GROUP BY month
ORDER BY month DESC;
```

### 2. ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥åˆ†æ

#### åˆ©ç”¨é »åº¦ãŒé«˜ã„ã‚°ãƒ«ãƒ¼ãƒ—Top 10
```sql
SELECT
  group_id,
  COUNT(*) as session_count,
  MIN(created_at) as first_use,
  MAX(created_at) as last_use
FROM sessions
GROUP BY group_id
ORDER BY session_count DESC
LIMIT 10;
```

#### ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®å¹³å‡ãƒ¡ãƒ³ãƒãƒ¼æ•°
```sql
SELECT
  group_id,
  COUNT(*) as sessions,
  AVG(json_array_length(data, '$.members')) as avg_members
FROM sessions
GROUP BY group_id
HAVING sessions >= 3;
```

### 3. æ”¯æ‰•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

#### åº—èˆ—æ•°ã®åˆ†å¸ƒï¼ˆä½•è»’ç›®ã¾ã§è¡Œãã‹ï¼‰
```sql
-- æ³¨: ã“ã‚Œã¯ä»®ã®ã‚¯ã‚¨ãƒªã€‚å®Ÿéš›ã«ã¯JSONã®æ§‹é€ æ¬¡ç¬¬
SELECT
  json_array_length(data, '$.payments') as venue_count,
  COUNT(*) as session_count
FROM sessions
WHERE status IN ('settled', 'completed')
GROUP BY venue_count
ORDER BY venue_count;
```

#### æ™‚é–“å¸¯åˆ¥ã®åˆ©ç”¨åˆ†å¸ƒ
```sql
SELECT
  CASE
    WHEN CAST(strftime('%H', created_at) AS INTEGER) BETWEEN 18 AND 21 THEN '18-21æ™‚'
    WHEN CAST(strftime('%H', created_at) AS INTEGER) BETWEEN 22 AND 24 THEN '22-24æ™‚'
    WHEN CAST(strftime('%H', created_at) AS INTEGER) BETWEEN 0 AND 3 THEN '0-3æ™‚'
    ELSE 'ãã®ä»–'
  END as time_slot,
  COUNT(*) as count
FROM sessions
GROUP BY time_slot
ORDER BY count DESC;
```

### 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æ

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ç‡
```sql
SELECT
  status,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
FROM sessions
GROUP BY status;
```

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¹³å‡ç¶™ç¶šæ™‚é–“
```sql
-- ä½œæˆã‹ã‚‰æ›´æ–°ã¾ã§ã®æ™‚é–“ï¼ˆç§’å˜ä½ï¼‰
SELECT
  AVG(julianday(updated_at) - julianday(created_at)) * 86400 as avg_duration_seconds,
  MIN(julianday(updated_at) - julianday(created_at)) * 86400 as min_duration_seconds,
  MAX(julianday(updated_at) - julianday(created_at)) * 86400 as max_duration_seconds
FROM sessions
WHERE status = 'settled';
```

### 5. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

#### ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡º
```sql
-- ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ãªã„ã‚»ãƒƒã‚·ãƒ§ãƒ³
SELECT id, group_id, created_at
FROM sessions
WHERE json_array_length(data, '$.members') = 0;

-- æ”¯æ‰•ã„ãŒãªã„ã®ã«æ¸…ç®—æ¸ˆã¿ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
SELECT id, group_id, status
FROM sessions
WHERE status = 'settled'
  AND json_array_length(data, '$.payments') = 0;
```

---

## ğŸ› ï¸ åˆ†æãƒ„ãƒ¼ãƒ«ã¨ã®é€£æº

### SQLiteãƒ–ãƒ©ã‚¦ã‚¶ã§å¯è¦–åŒ–

```bash
# Raspberry Piä¸Šã§SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã
sqlite3 ~/tatekaezamurai-bot/server/dist/data/database.db

# ã¾ãŸã¯ã€GUIãƒ„ãƒ¼ãƒ«ï¼ˆMac/Windowsï¼‰
# - DB Browser for SQLite
# - TablePlus
# - DBeaver
```

### Pythonã§ãƒ‡ãƒ¼ã‚¿åˆ†æ

```python
import sqlite3
import pandas as pd
import matplotlib.pyplot as plt

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
conn = sqlite3.connect('database.db')

# DataFrameã«èª­ã¿è¾¼ã¿
df = pd.read_sql_query("""
    SELECT
        date(created_at) as date,
        COUNT(*) as sessions
    FROM sessions
    WHERE created_at >= date('now', '-30 days')
    GROUP BY date
    ORDER BY date
""", conn)

# ã‚°ãƒ©ãƒ•åŒ–
df.plot(x='date', y='sessions', kind='line')
plt.title('Daily Sessions - Last 30 Days')
plt.show()
```

### Node.jsã§ã‚«ã‚¹ã‚¿ãƒ åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```typescript
// server/src/scripts/analyze-sessions.ts
import { databaseService } from '../services/databaseService';

const db = databaseService.db;

const stats = db.prepare(`
  SELECT
    COUNT(*) as total,
    COUNT(CASE WHEN status = 'active' THEN 1 END) as active
  FROM sessions
`).get();

console.log('çµ±è¨ˆ:', stats);
```

---

## ğŸ“Š BIï¼ˆBusiness Intelligenceï¼‰ã¸ã®ç™ºå±•

ä»Šå¾Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ï¼š

1. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ**
   - Grafana, Metabaseãªã©ã¨é€£æº
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆè¡¨ç¤º

2. **æ©Ÿæ¢°å­¦ç¿’ã¸ã®å¿œç”¨**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®äºˆæ¸¬
   - ç•°å¸¸æ¤œçŸ¥ï¼ˆä¸æ­£åˆ©ç”¨ãªã©ï¼‰

3. **A/Bãƒ†ã‚¹ãƒˆ**
   - æ©Ÿèƒ½æ”¹å–„ã®åŠ¹æœæ¸¬å®š
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã®åˆ†æ

---

## ğŸš¨ é‡è¦ãªæ³¨æ„äº‹é …

### JSONãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„

ç¾åœ¨ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ `data` ã‚«ãƒ©ãƒ ã«JSONå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼š

```sql
-- JSONã®ä¸­èº«ã‚’å–å¾—
SELECT json_extract(data, '$.members') FROM sessions;

-- é…åˆ—ã®é•·ã•
SELECT json_array_length(data, '$.members') FROM sessions;
```

SQLiteã®JSONé–¢æ•°ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡é›‘ãªåˆ†æãŒå¯èƒ½ã§ã™ï¼š
https://www.sqlite.org/json1.html

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åˆ†ææ™‚ã¯ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ã¦ãã ã•ã„ï¼š

```sql
-- æ—¢å­˜ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
-- idx_sessions_group (group_id)
-- idx_sessions_status (status)
-- idx_sessions_created (created_at)

-- å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
CREATE INDEX idx_sessions_updated ON sessions(updated_at);
```

---

## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **analytics_events ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ´»ç”¨**
   - æ—¢ã«ã‚¹ã‚­ãƒ¼ãƒã«å«ã¾ã‚Œã¦ã„ã¾ã™
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã®ãƒ­ã‚°ã‚’è“„ç©
   - ã‚ˆã‚Šè©³ç´°ãªåˆ†æãŒå¯èƒ½

2. **å®šæœŸãƒ¬ãƒãƒ¼ãƒˆ**
   - cronã§å®šæœŸçš„ã«çµ±è¨ˆã‚’ç”Ÿæˆ
   - ãƒ¡ãƒ¼ãƒ«ã‚„Slackã«é€šçŸ¥

3. **APIåŒ–**
   - çµ±è¨ˆæƒ…å ±ã‚’REST APIã§æä¾›
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å¯è¦–åŒ–
