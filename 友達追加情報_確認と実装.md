# ğŸ‘¥ å‹é”è¿½åŠ æƒ…å ± - ç¢ºèªã¨å®Ÿè£…

**ä½œæˆæ—¥**: 2026å¹´1æœˆ25æ—¥

---

## ğŸ” ç¾çŠ¶ã®ç¢ºèª

### ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰å‹•ä½œ

`index.ts` (è¡Œ68-82) ã‚’è¦‹ã‚‹ã¨ï¼š

```typescript
events.map(async (event) => {
  console.log('ğŸ“¨ ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡:', JSON.stringify(event, null, 2));
  if (event.type === 'message') {
    await commandHandler.handleMessage(event);
  } else if (event.type === 'join') {
    await commandHandler.handleJoin(event);
  }
  // â˜… follow ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒãªã„
});
```

**ç¾çŠ¶**:
- âœ… `follow` ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå‹é”è¿½åŠ ï¼‰ã¯**å—ä¿¡ã—ã¦ã„ã‚‹**
- âœ… ãƒ­ã‚°ã«ã¯**å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹**
- âŒ ç‰¹åˆ¥ãªå‡¦ç†ã¯**ã—ã¦ã„ãªã„**
- âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯**ä¿å­˜ã—ã¦ã„ãªã„**

---

## ğŸ“Š ãƒ­ã‚°ã‹ã‚‰åˆ†ã‹ã‚‹æƒ…å ±

### ãƒ­ã‚°ã®å†…å®¹

ä»¥å‰ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª `follow` ã‚¤ãƒ™ãƒ³ãƒˆãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã—ãŸï¼š

```json
ğŸ“¨ ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡: {
  "type": "follow",
  "follow": {
    "isRedelivery": false
  },
  "webhookEventId": "01KFPQQXT92QJXK379666DT4CE",
  "timestamp": 1769215882576,
  "source": {
    "type": "user",
    "userId": "Uaac31b026cf02ebf607ed2f372884e4c"
  },
  "replyToken": "ae515d49bf124023aff76bb1b31c87ff",
  "mode": "active"
}
```

**åˆ†ã‹ã‚‹ã“ã¨**:
- âœ… **userId**: `Uaac31b026cf02ebf607ed2f372884e4c`
- âœ… **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: `1769215882576` (2026-01-23 ç´„17:00 JST)
- âŒ **displayName**: å«ã¾ã‚Œã¦ã„ãªã„ï¼ˆåˆ¥é€”APIã§å–å¾—ãŒå¿…è¦ï¼‰

---

## ğŸš« displayName ãŒåˆ†ã‹ã‚‰ãªã„ç†ç”±

LINE Webhookã® `follow` ã‚¤ãƒ™ãƒ³ãƒˆã«ã¯ã€**userId ã—ã‹å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“**ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ï¼ˆdisplayNameï¼‰ã‚’å–å¾—ã™ã‚‹ã«ã¯ï¼š

1. **userId ã‚’å–å¾—**ï¼ˆfollow ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ï¼‰
2. **LINE API ã‚’å‘¼ã¶**: `client.getProfile(userId)`
3. **displayName ã‚’å–å¾—**

---

## ğŸ” éå»ã®å‹é”è¿½åŠ ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•

### æ–¹æ³•1: ãƒ­ã‚°ã‹ã‚‰ userId ã‚’æŠ½å‡º

```bash
# Raspberry Pi ã§ãƒ­ã‚°ã‚’ç¢ºèª
cd ~/tatekaezamurai-bot/server
pm2 logs --lines 5000 | grep '"type": "follow"' -A 10

# ã¾ãŸã¯ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰
grep '"type": "follow"' ~/.pm2/logs/tatekaezamurai-out.log -A 10
```

**å‡ºåŠ›ä¾‹**:
```json
"type": "follow",
...
"userId": "Uaac31b026cf02ebf607ed2f372884e4c"
```

### æ–¹æ³•2: userId ã‹ã‚‰åå‰ã‚’å–å¾—

å–å¾—ã—ãŸ userId ã‚’ä½¿ã£ã¦ã€LINE API ã§åå‰ã‚’å–å¾—ï¼š

**ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ**: `server/src/scripts/get-user-info.ts`

```typescript
import * as line from '@line/bot-sdk';
import * as dotenv from 'dotenv';

dotenv.config();

const client = new line.messagingApi.MessagingApiClient({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN || '',
});

async function getUserInfo(userId: string) {
  try {
    const profile = await client.getProfile(userId);
    console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:');
    console.log(`  ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`);
    console.log(`  è¡¨ç¤ºå: ${profile.displayName}`);
    console.log(`  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${profile.statusMessage || '(ãªã—)'}`);
    console.log(`  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ: ${profile.pictureUrl || '(ãªã—)'}`);
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
    console.log('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã‹ã€ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™');
  }
}

const userId = process.argv[2];
if (!userId) {
  console.error('ä½¿ã„æ–¹: ts-node src/scripts/get-user-info.ts <USER_ID>');
  process.exit(1);
}

getUserInfo(userId);
```

**å®Ÿè¡Œæ–¹æ³•**:

```bash
cd ~/tatekaezamurai-bot/server
ts-node src/scripts/get-user-info.ts Uaac31b026cf02ebf607ed2f372884e4c
```

**å‡ºåŠ›ä¾‹**:
```
ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: Uaac31b026cf02ebf607ed2f372884e4c
  è¡¨ç¤ºå: ç”°ä¸­å¤ªéƒ
  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™
  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ: https://profile.line-scdn.net/...
```

---

## âœ¨ å‹é”è¿½åŠ æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ï¼ˆææ¡ˆï¼‰

### å®Ÿè£…æ¡ˆ

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 

```sql
-- friends ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE friends (
  user_id TEXT PRIMARY KEY,
  display_name TEXT NOT NULL,
  picture_url TEXT,
  status_message TEXT,
  followed_at TEXT NOT NULL,
  unfollowed_at TEXT,
  is_active INTEGER DEFAULT 1,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

CREATE INDEX idx_friends_followed_at ON friends(followed_at);
CREATE INDEX idx_friends_is_active ON friends(is_active);
```

#### 2. followã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ 

`commandHandler.ts` ã«è¿½åŠ ï¼š

```typescript
// å‹é”è¿½åŠ æ™‚ã®å‡¦ç†
async handleFollow(event: line.WebhookEvent): Promise<void> {
  if (event.type !== 'follow') return;

  const userId = event.source.userId;
  if (!userId) return;

  try {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const profile = await client.getProfile(userId);

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    await friendService.saveFriend({
      userId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl || '',
      statusMessage: profile.statusMessage || '',
      followedAt: new Date().toISOString(),
      isActive: true,
    });

    console.log(`ğŸ‘¤ å‹é”è¿½åŠ : ${profile.displayName} (${userId})`);

    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    await client.replyMessage({
      replyToken: event.replyToken,
      messages: [{
        type: 'text',
        text: `${profile.displayName}ã•ã‚“ã€å‹é”è¿½åŠ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\næ¸…ç®—ãã‚“ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã§ã®å‰²ã‚Šå‹˜ã‚’ç°¡å˜ã«ã™ã‚‹Botã§ã™ã€‚\n\nã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã¦ã€Œé–‹å§‹ã€ã¨é€ä¿¡ã—ã¦ãã ã•ã„ã€‚`,
      }],
    });
  } catch (error) {
    console.error('âŒ å‹é”è¿½åŠ å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
}
```

#### 3. index.ts ã‚’ä¿®æ­£

```typescript
events.map(async (event) => {
  console.log('ğŸ“¨ ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡:', JSON.stringify(event, null, 2));
  if (event.type === 'message') {
    await commandHandler.handleMessage(event);
  } else if (event.type === 'join') {
    await commandHandler.handleJoin(event);
  } else if (event.type === 'follow') {
    // â˜… è¿½åŠ 
    await commandHandler.handleFollow(event);
  }
});
```

#### 4. ãƒ–ãƒ­ãƒƒã‚¯æ¤œçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```typescript
// ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®å‡¦ç†
async handleUnfollow(event: line.WebhookEvent): Promise<void> {
  if (event.type !== 'unfollow') return;

  const userId = event.source.userId;
  if (!userId) return;

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
  await friendService.updateFriend(userId, {
    unfollowedAt: new Date().toISOString(),
    isActive: false,
  });

  console.log(`ğŸ‘‹ ãƒ–ãƒ­ãƒƒã‚¯/å‹é”è§£é™¤: ${userId}`);
}
```

---

## ğŸ“Š çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º

å‹é”è¿½åŠ æƒ…å ±ã‚’ä¿å­˜ã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµ±è¨ˆãŒè¦‹ã‚Œã¾ã™ï¼š

```sql
-- å‹é”æ•°
SELECT COUNT(*) as total_friends FROM friends WHERE is_active = 1;

-- ä»Šæœˆã®å‹é”è¿½åŠ æ•°
SELECT COUNT(*) as new_friends_this_month
FROM friends
WHERE followed_at >= date('now', 'start of month');

-- å‹é”è¿½åŠ ã®æ¨ç§»ï¼ˆæ—¥åˆ¥ï¼‰
SELECT
  date(followed_at) as date,
  COUNT(*) as count
FROM friends
GROUP BY date(followed_at)
ORDER BY date DESC
LIMIT 30;

-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå‹é”ä¸€è¦§
SELECT
  display_name,
  followed_at
FROM friends
WHERE is_active = 1
ORDER BY followed_at DESC;
```

---

## ğŸ¯ å®Ÿè£…ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆ

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **å‹é”æ•°ãŒåˆ†ã‹ã‚‹** | ä½•äººãŒBotã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã‹æŠŠæ¡ã§ãã‚‹ |
| **å¢—åŠ å‚¾å‘ãŒè¦‹ãˆã‚‹** | æ—¥åˆ¥ãƒ»æœˆåˆ¥ã®å‹é”è¿½åŠ æ•°ã‚’åˆ†æã§ãã‚‹ |
| **ãƒ–ãƒ­ãƒƒã‚¯ç‡ãŒåˆ†ã‹ã‚‹** | ã‚¢ãƒ³ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‹ã‚‰æº€è¶³åº¦ã‚’æ¨æ¸¬ã§ãã‚‹ |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†** | å€‹åˆ¥ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹éš›ã«åå‰ãŒåˆ†ã‹ã‚‹ |
| **çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ** | é‹å–¶çŠ¶æ³ã‚’å¯è¦–åŒ–ã§ãã‚‹ |

---

## ğŸ“ å®Ÿè£…é›£æ˜“åº¦

| é …ç›® | é›£æ˜“åº¦ | æ™‚é–“ |
|------|--------|------|
| ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆï¼ˆuserIdâ†’åå‰ï¼‰ | ğŸŸ¢ ç°¡å˜ | 15åˆ† |
| followãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ  | ğŸŸ¢ ç°¡å˜ | 30åˆ† |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ  | ğŸŸ¡ ä¸­ç¨‹åº¦ | 1æ™‚é–“ |
| çµ±è¨ˆæ©Ÿèƒ½ | ğŸŸ¡ ä¸­ç¨‹åº¦ | 1æ™‚é–“ |

**åˆè¨ˆ**: ç´„3æ™‚é–“

---

## ğŸš€ ä»Šã™ãã§ãã‚‹ã“ã¨

### Step 1: ãƒ­ã‚°ã‹ã‚‰ userId ã‚’ç¢ºèª

```bash
cd ~/tatekaezamurai-bot/server
pm2 logs --lines 5000 | grep '"type": "follow"' -A 10 > follow_events.txt
cat follow_events.txt
```

### Step 2: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§åå‰ã‚’å–å¾—

ä¸Šè¨˜ã® `get-user-info.ts` ã‚’ä½œæˆã—ã¦å®Ÿè¡Œã€‚

### Step 3: å‹é”è¿½åŠ æ©Ÿèƒ½ã®å®Ÿè£…ã‚’æ¤œè¨

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ‹ãƒ¼ã‚ºãŒã‚ã‚Œã°ã€ä¸Šè¨˜ã®å®Ÿè£…æ¡ˆã‚’é©ç”¨ã€‚

---

## ğŸ¯ çµè«–

**ç¾çŠ¶**:
- âŒ å‹é”è¿½åŠ ã—ãŸäººã®åå‰ã¯**ç›´æ¥ç¢ºèªã§ããªã„**
- âœ… ãƒ­ã‚°ã‹ã‚‰ **userId ã¯å–å¾—ã§ãã‚‹**
- âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã‚Œã° **åå‰ã‚’å–å¾—ã§ãã‚‹**

**æ¨å¥¨**:
1. ã¾ãšã€ãƒ­ã‚°ã‹ã‚‰ userId ã‚’æŠ½å‡º
2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§åå‰ã‚’å–å¾—
3. ä»Šå¾Œã®ãŸã‚ã« follow ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…

**å®Ÿè£…ã™ã‚‹ä¾¡å€¤**: â­â­â­â­ (é«˜ã„)
- å‹é”æ•°ã®æŠŠæ¡
- å¢—åŠ å‚¾å‘ã®åˆ†æ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®æ”¹å–„
