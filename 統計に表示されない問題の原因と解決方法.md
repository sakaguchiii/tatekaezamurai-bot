# ğŸ› çµ±è¨ˆã«è¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã®åŸå› ã¨è§£æ±ºæ–¹æ³•

**ä½œæˆæ—¥**: 2026å¹´1æœˆ23æ—¥

---

## â“ å•é¡Œ

> ã€Œæ˜¨æ—¥ä½¿ã£ãŸã®ã«çµ±è¨ˆã«å…¥ã£ã¦ã„ãªã„ã®ã¯ãªãœï¼Ÿã€

ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨ï¼š

```
# æ˜¨æ—¥ï¼ˆ1æœˆ22æ—¥ï¼‰ã®ä½¿ç”¨å±¥æ­´
âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ: C47ef98c5919d7d136435d939f9fd7c99
ğŸ’° æ”¯æ‰•ã„è¿½åŠ : ... - 1è»’ç›® 2000å††
ğŸ’¾ 1ä»¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸€æ‹¬ä¿å­˜ã—ã¾ã—ãŸ
âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†: C47ef98c5919d7d136435d939f9fd7c99

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæ™‚ï¼ˆåˆå‰3æ™‚ï¼‰
ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: 9, ã‚µã‚¤ã‚º: 20.22 KB  â† ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã™ã‚‹

# ã§ã‚‚ã€npm run export-json:stats ã‚’å®Ÿè¡Œã™ã‚‹ã¨
ğŸ“ˆ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ï¼‰:
ï¼ˆç©ºï¼‰

ğŸ’° æ”¯æ‰•ã„çµ±è¨ˆ:
   ç·æ”¯æ‰•ã„ä»¶æ•°: 0ä»¶  â† ãªãœã‹0ä»¶ï¼
```

**æ˜ã‚‰ã‹ã«çŸ›ç›¾ã—ã¦ã„ã¾ã™ã€‚** ãªãœã§ã—ã‚‡ã†ã‹ï¼Ÿ

---

## ğŸ” åŸå› 

### 2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹

Raspberry Piã«ã¯ã€**ç•°ãªã‚‹å ´æ‰€ã«2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«**ãŒã‚ã‚Šã¾ã™ï¼š

```
server/
â”œâ”€â”€ dist/data/database.db        â† æœ¬ç•ªç’°å¢ƒï¼ˆpm2ãŒä½¿ç”¨ï¼‰
â””â”€â”€ src/data/database.db         â† é–‹ç™ºç’°å¢ƒï¼ˆnpm scriptsãŒä½¿ç”¨ï¼‰
```

### ãã‚Œãã‚ŒãŒä½¿ã‚ã‚Œã‚‹å ´é¢

| ãƒ•ã‚¡ã‚¤ãƒ« | ä½¿ã‚ã‚Œã‚‹å ´é¢ | èª¬æ˜ |
|---------|------------|------|
| **dist/data/database.db** | pm2èµ·å‹•æ™‚ | æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿéš›ã«ä½¿ç”¨ |
| **src/data/database.db** | npm scriptsã‚„ `ts-node` | é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ |

---

## ğŸ“Š å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### æ˜¨æ—¥ï¼ˆ1æœˆ22æ—¥ï¼‰ã®æµã‚Œ

```
1. LINEã§ã€Œé–‹å§‹ã€ã€Œç²¾ç®—ã€
   â†“
2. pm2ã§èµ·å‹•ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ãŒå‡¦ç†
   â†“
3. dist/data/database.db ã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
   â†“
4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒ“ã‚¹ãŒ dist/data/database.db ã‚’èª­ã¿è¾¼ã¿
   â†“
5. åˆå‰3æ™‚: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
   ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: 9, ã‚µã‚¤ã‚º: 20.22 KB  â† dist/data/ ã‹ã‚‰èª­ã¿å–ã‚Š
```

### npm run export-json:stats ã‚’å®Ÿè¡Œã—ãŸã¨ã

```
1. npm run export-json:stats ã‚’å®Ÿè¡Œ
   â†“
2. ts-node src/scripts/export-json.ts ãŒèµ·å‹•
   â†“
3. databaseService.ts ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
   â†“
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãŒæ±ºã¾ã‚‹:
   const DB_PATH = path.join(__dirname, '../data/database.db');

   __dirname = '/home/sk283/tatekaezamurai-bot/server/src/services'
   â†’ /home/sk283/tatekaezamurai-bot/server/src/data/database.db  â† ã“ã£ã¡ã‚’è¦‹ã‚‹ï¼
   â†“
5. src/data/database.db ã‚’é–‹ãï¼ˆç©ºã¾ãŸã¯å¤ã„ãƒ‡ãƒ¼ã‚¿ï¼‰
   â†“
6. ğŸ“ˆ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: 0ä»¶  â† å½“ç„¶0ä»¶
```

---

## ğŸ”§ è§£æ±ºæ–¹æ³•

### æ–¹æ³•1: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç›´æ¥ç¢ºèªï¼ˆæ¨å¥¨ï¼‰

```bash
# Raspberry Piã«æ¥ç¶š
ssh sk283@raspberrypi.local
cd ~/tatekaezamurai-bot/server

# æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç›´æ¥ç¢ºèª
sqlite3 dist/data/database.db "SELECT COUNT(*) FROM sessions;"

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®ä»¶æ•°
sqlite3 dist/data/database.db "SELECT status, COUNT(*) FROM sessions GROUP BY status;"

# è©³ç´°æƒ…å ±
sqlite3 dist/data/database.db << EOF
.headers on
.mode column
SELECT id, status, created_at FROM sessions ORDER BY created_at DESC LIMIT 10;
EOF
```

**ã“ã‚ŒãŒæœ€ã‚‚ç¢ºå®Ÿãªæ–¹æ³•ã§ã™ã€‚**

---

### æ–¹æ³•2: export-json.tsã‚’ä¿®æ­£ã—ã¦æœ¬ç•ªDBã‚’è¦‹ã‚‹

#### ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰

`databaseService.ts` (è¡Œ7-8):
```typescript
const DATA_DIR = path.join(__dirname, '../data');
const DB_PATH = path.join(DATA_DIR, 'database.db');
```

ã“ã‚Œã ã¨ã€`ts-node` ã§å®Ÿè¡Œæ™‚ã« `src/data/` ã‚’è¦‹ã¦ã—ã¾ã„ã¾ã™ã€‚

#### ä¿®æ­£æ¡ˆA: ç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆ

```typescript
// databaseService.ts
const DATA_DIR = process.env.NODE_ENV === 'production'
  ? path.join(__dirname, '../data')      // dist/data/
  : path.join(__dirname, '../../dist/data');  // src â†’ dist/data/

const DB_PATH = path.join(DATA_DIR, 'database.db');
```

#### ä¿®æ­£æ¡ˆB: çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ã†

```typescript
// databaseService.ts
const DATA_DIR = process.env.DB_PATH || path.join(__dirname, '../data');
const DB_PATH = path.join(DATA_DIR, 'database.db');
```

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ :
```
DB_PATH=/home/sk283/tatekaezamurai-bot/server/dist/data
```

#### ä¿®æ­£æ¡ˆC: npm scriptã§æœ¬ç•ªDBã‚’æŒ‡å®š

```bash
# ç›´æ¥æŒ‡å®šã—ã¦å®Ÿè¡Œ
cd ~/tatekaezamurai-bot/server
DB_PATH=dist/data ts-node src/scripts/export-json.ts --stats
```

---

### æ–¹æ³•3: npm scriptã‚’å¤‰æ›´ï¼ˆæœ€ã‚‚ç°¡å˜ï¼‰

`package.json` ã‚’ä¿®æ­£:

**ç¾åœ¨**:
```json
"export-json:stats": "ts-node src/scripts/export-json.ts --stats"
```

**ä¿®æ­£å¾Œ**:
```json
"export-json:stats": "node dist/scripts/export-json.js --stats"
```

**ãªãœã“ã‚ŒãŒè‰¯ã„ã‹**:
- `node dist/...` ã§å®Ÿè¡Œã™ã‚‹ã¨ã€`__dirname` ã¯ `dist/scripts` ã«ãªã‚‹
- `path.join(__dirname, '../data')` ã§ `dist/data` ã‚’å‚ç…§ã§ãã‚‹
- æœ¬ç•ªç’°å¢ƒã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‰ã‚Œã‚‹

**æ³¨æ„**: ãƒ“ãƒ«ãƒ‰ãŒå¿…è¦
```bash
npm run build
npm run export-json:stats
```

---

## ğŸ¯ æ¨å¥¨ã™ã‚‹å¯¾å¿œ

### çŸ­æœŸçš„ï¼ˆä»Šã™ãï¼‰

```bash
# æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç›´æ¥ç¢ºèª
sqlite3 dist/data/database.db "SELECT status, COUNT(*) FROM sessions GROUP BY status;"
```

ã“ã‚Œã§ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚

### ä¸­æœŸçš„ï¼ˆæ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰

**ä¿®æ­£æ¡ˆB**ã‚’å®Ÿè£…:

1. **databaseService.tsã‚’ä¿®æ­£**
```typescript
// ç’°å¢ƒå¤‰æ•°ã§æœ¬ç•ªDBã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
const DATA_DIR = process.env.DB_DATA_DIR || path.join(__dirname, '../data');
const DB_PATH = path.join(DATA_DIR, 'database.db');
```

2. **.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ **ï¼ˆRaspberry Piä¸Šï¼‰
```bash
# ~/tatekaezamurai-bot/server/.env
DB_DATA_DIR=/home/sk283/tatekaezamurai-bot/server/dist/data
```

3. **package.jsonã‚’æ›´æ–°**
```json
"export-json:stats": "source .env && ts-node src/scripts/export-json.ts --stats"
```

---

## ğŸ“ ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªï¼ˆå®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰ï¼‰

Raspberry Piã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```bash
# Step 1: sqlite3ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã¾ã ã®å ´åˆï¼‰
sudo apt-get install -y sqlite3

# Step 2: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèª
cd ~/tatekaezamurai-bot/server

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç·æ•°
sqlite3 dist/data/database.db "SELECT COUNT(*) FROM sessions;"

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode column
SELECT status, COUNT(*) as count FROM sessions GROUP BY status;
EOF

# æ˜¨æ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ1æœˆ22æ—¥ï¼‰
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode column
SELECT id, status, created_at
FROM sessions
WHERE DATE(created_at) = '2026-01-22'
ORDER BY created_at;
EOF
```

**ã“ã‚Œã§ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆã‚‹ã¯ãšã§ã™ï¼**

---

## ğŸ› ãªãœã“ã®å•é¡ŒãŒèµ·ããŸã®ã‹ï¼Ÿ

### è¨­è¨ˆä¸Šã®å•é¡Œ

TypeScriptã®ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã§ï¼š
1. `tsc` ã¯ `.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `.js` ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
2. `src/` â†’ `dist/` ã«å‡ºåŠ›
3. **ã—ã‹ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ”ãƒ¼ã—ãªã„**

çµæœ:
- `src/data/database.db` ã¨ `dist/data/database.db` ãŒåˆ¥ã€…ã«å­˜åœ¨
- ã©ã¡ã‚‰ã‚’ä½¿ã†ã‹ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå®Ÿè¡Œæ–¹æ³•ï¼‰ã«ä¾å­˜

### ç†æƒ³çš„ãªæ§‹é€ 

```
server/
â”œâ”€â”€ dist/           # ãƒ“ãƒ«ãƒ‰å¾Œã®ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ services/
â”‚
â”œâ”€â”€ data/           # ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ1ã¤ã ã‘ï¼‰
â”‚   â”œâ”€â”€ database.db
â”‚   â””â”€â”€ backups/
â”‚
â””â”€â”€ src/            # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
    â”œâ”€â”€ scripts/
    â””â”€â”€ services/
```

ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ãŒ `data/database.db` ã‚’å‚ç…§ã™ã‚‹ã®ãŒç†æƒ³ã§ã™ã€‚

---

## âœ… ã¾ã¨ã‚

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|---------|
| çµ±è¨ˆãŒ0ä»¶ | `src/data/` ã‚’è¦‹ã¦ã„ã‚‹ | `dist/data/` ã‚’ç›´æ¥ç¢ºèª |
| npm scriptã§ç¢ºèªã§ããªã„ | ãƒ‘ã‚¹ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | ç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆ |

**ä»Šã™ãç¢ºèªã™ã‚‹ã«ã¯**:
```bash
sqlite3 dist/data/database.db "SELECT COUNT(*) FROM sessions;"
```

**å°†æ¥çš„ã«ã¯**:
- databaseService.tsã‚’ä¿®æ­£
- ç’°å¢ƒå¤‰æ•°ã§ãƒ‘ã‚¹ã‚’æŒ‡å®šå¯èƒ½ã«ã™ã‚‹

---

**ã“ã‚Œã§ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ï¼æ˜¨æ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç¢ºå®Ÿã« dist/data/database.db ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚** ğŸ”
