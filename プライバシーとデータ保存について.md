# 🔐 プライバシーとデータ保存について

**最終更新**: 2026年1月23日

このドキュメントは、清算くんが**何を保存し、何を保存していないか**を明確に説明します。

---

## ❓ よくある質問

### Q: グループでのトーク内容を保存していますか？

**A: いいえ、データベースには保存していません。**

ただし、**サーバーのログには一時的に記録されます**（詳細は後述）。

---

## 📦 何が保存されるか（詳細）

### 1. データベース（SQLite）に保存されるもの ✅

| データ | 保存される？ | 説明 |
|--------|------------|------|
| **LINEグループID** | ✅ Yes | グループを識別するため |
| **LINEユーザーID** | ✅ Yes | メンバーを識別するため |
| **ユーザーの表示名** | ✅ Yes | 「太郎さん」「花子さん」など |
| **支払い金額** | ✅ Yes | 5000円、8000円など |
| **店舗情報** | ✅ Yes | 「1軒目」「2軒目」など |
| **精算結果** | ✅ Yes | 「太郎→花子: 2000円」など |
| **セッションの状態** | ✅ Yes | active/settled/completed |
| **日時** | ✅ Yes | 作成日時、更新日時 |

**保存されないもの** ❌:
- トークの内容（「おはよう」「今日はどこ行く？」など）
- コマンド以外のメッセージ
- スタンプ、画像、動画
- 通話履歴

---

### 2. サーバーログに記録されるもの ⚠️

**場所**: `~/.pm2/logs/tatekaezamurai-out.log`

サーバーログには、**デバッグのため**に以下が記録されます：

```javascript
console.log('📨 イベントを受信:', JSON.stringify(event, null, 2));
```

**記録される内容**:
- **メッセージテキスト** → 「開始」「1軒目 5000」など
- LINEグループID
- LINEユーザーID
- タイムスタンプ
- その他のメタデータ

**具体例**:
```json
{
  "type": "message",
  "message": {
    "type": "text",
    "text": "1軒目 5000"  ← これがログに記録される
  },
  "source": {
    "type": "group",
    "groupId": "C48819908d9907fd29bf67958dc6de9f7",
    "userId": "Ucdc6f609c888a5de55a124e70aa68d6d"
  }
}
```

**重要**:
- ログは**ローカル**（Raspberry Pi内）にのみ保存
- **外部サーバーには送信されない**
- pm2が管理（`pm2 logs` で閲覧可能）

---

### 3. ログの保管期間

pm2のデフォルト設定では：
- **無制限に保存される**
- ディスク容量がいっぱいになるまで蓄積

**推奨設定**: ログローテーション（古いログを自動削除）

```bash
# pm2-logroateをインストール
pm2 install pm2-logrotate

# 設定
pm2 set pm2-logrotate:max_size 10M        # 10MBで分割
pm2 set pm2-logrotate:retain 7            # 7日分保持
pm2 set pm2-logrotate:compress true       # 圧縮する
```

**設定後**:
- ログファイルが10MBに達すると自動的に分割
- 7日より古いログは自動削除
- ディスク容量を節約

---

## 🔍 実際に確認する方法

### データベースの中身を確認

```bash
# Raspberry Piに接続
ssh sk283@raspberrypi.local

# データベースを開く
cd ~/tatekaezamurai-bot/server
sqlite3 dist/data/database.db

# セッションデータを表示
SELECT data FROM sessions LIMIT 1;
```

**出力例**（JSON形式）:
```json
{
  "groupId": "C488...",
  "members": [
    {"userId": "Ucdc...", "displayName": "太郎"}
  ],
  "payments": [
    {"venue": "1軒目", "amount": 5000}
  ]
}
```

→ **トークの内容は含まれていません**

---

### ログファイルの中身を確認

```bash
# 最新50行を表示
pm2 logs --lines 50

# または直接ファイルを見る
tail -50 ~/.pm2/logs/tatekaezamurai-out.log
```

**出力例**:
```
📨 イベントを受信: {
  "message": {
    "text": "開始"  ← コマンドテキストが記録される
  }
}
💰 支払い追加: C488... - 1軒目 5000円
```

→ **コマンドのテキストは記録されています**

---

## 🛡️ プライバシー保護のために

### 1. ログを定期的に削除

```bash
# ログを手動で削除
pm2 flush

# または、pm2-logrotate を設定（推奨）
```

### 2. データベースを暗号化（上級者向け）

現在、データベースファイルは**暗号化されていません**。

暗号化したい場合:
- SQLCipher を使用
- または、ディスク全体を暗号化（Raspberry PiのLUKS）

### 3. アクセス制限

```bash
# データベースファイルのパーミッションを確認
ls -l ~/tatekaezamurai-bot/server/dist/data/database.db

# 自分だけが読めるように設定
chmod 600 ~/tatekaezamurai-bot/server/dist/data/database.db
```

---

## 🌐 外部への送信

### LINE Messaging API

清算くんは、LINEの公式APIを使用してメッセージを送信します。

**LINEサーバーに送信されるもの**:
- 返信メッセージ（「✅ セッション開始」など）
- グループID（返信先を特定するため）

**LINEサーバーに送信されないもの**:
- データベースの内容
- ログファイル
- セッションの詳細データ

**LINE社のプライバシーポリシー**:
https://line.me/ja/terms/policy/

---

### その他の外部サービス

清算くんは、以下の外部サービスに**一切データを送信しません**:
- Google Analytics
- クラウドストレージ（AWS, Google Cloud, Azureなど）
- 分析ツール
- 広告サービス

**完全にローカル**で動作します（Raspberry Pi内のみ）。

---

## 📊 データの用途

### 保存されたデータは何に使われる？

1. **セッション管理**
   - 「誰が参加しているか」
   - 「いくら支払ったか」
   - 「精算結果」

2. **統計情報**（将来的に）
   - グループごとの利用回数
   - 平均メンバー数
   - 総支払い額

3. **トラブルシューティング**
   - エラー発生時の原因調査
   - ログで動作確認

**使われないこと**:
- ❌ 広告配信
- ❌ 第三者への提供
- ❌ マーケティング

---

## 🗑️ データの削除

### 1. 特定のセッションを削除

```bash
sqlite3 ~/tatekaezamurai-bot/server/dist/data/database.db

# セッションIDを確認
SELECT id, group_id FROM sessions;

# 削除
DELETE FROM sessions WHERE id = 'セッションID';
```

### 2. 全データを削除

```bash
# データベースを削除
rm ~/tatekaezamurai-bot/server/dist/data/database.db

# バックアップも削除
rm -rf ~/tatekaezamurai-bot/server/dist/data/backups/

# ログも削除
pm2 flush
```

### 3. サービスを完全に停止・削除

```bash
# サーバー停止
pm2 stop all
pm2 delete all

# データを削除
rm -rf ~/tatekaezamurai-bot

# アンインストール完了
```

---

## 🔐 GDPRやプライバシー法への対応

清算くんは個人が運用する小規模なbotですが、以下の点でプライバシーに配慮しています：

### ✅ 実装済み

1. **データ最小化**
   - 必要最小限のデータのみ保存
   - トーク内容は保存しない

2. **透明性**
   - このドキュメントで何を保存しているか公開

3. **ローカル保存**
   - クラウドではなく、自分のRaspberry Piに保存

4. **データ削除可能**
   - いつでも削除できる

### ⚠️ 未実装（必要に応じて追加）

1. **暗号化**
   - データベースファイルは平文

2. **匿名化**
   - ユーザーIDや表示名をそのまま保存

3. **同意取得**
   - 利用開始時に同意を求める機能なし

---

## 📝 まとめ

| 項目 | 保存される？ | 保存場所 | 削除方法 |
|------|------------|---------|---------|
| **トーク内容（コマンド以外）** | ❌ No | - | - |
| **コマンド（「開始」など）** | ⚠️ ログのみ | Raspberry Pi | `pm2 flush` |
| **ユーザーID・表示名** | ✅ Yes | データベース | SQL DELETE |
| **支払い金額・店舗** | ✅ Yes | データベース | SQL DELETE |
| **精算結果** | ✅ Yes | データベース | SQL DELETE |

---

## ❓ よくある質問

### Q1. LINEで送った個人的なメッセージは保存される？

**A**: いいえ。清算くんは**コマンド**（「開始」「精算」など）にのみ反応し、それ以外のメッセージは無視します。ログに一時的に記録されますが、データベースには保存されません。

---

### Q2. 過去のトーク履歴を見られる？

**A**: いいえ。清算くんは過去のトーク履歴にアクセスできません。Webhookで届いた**新しいメッセージのみ**を処理します。

---

### Q3. グループから退出したら、データも消える？

**A**: いいえ。データは残ります。削除したい場合は、手動でデータベースから削除する必要があります。

---

### Q4. 運営者（開発者）は私のデータを見られる？

**A**: Raspberry Piにアクセスできる人は、すべてのデータを見ることができます。
- データベースファイル
- ログファイル

**対策**: 信頼できる人だけにRaspberry Piへのアクセス権を与えてください。

---

### Q5. データ漏洩のリスクは？

**A**: 以下のリスクがあります：
1. **Raspberry Piが盗まれる** → データベースファイルが盗まれる
2. **ネットワーク侵入** → 不正アクセスされる
3. **SDカードの破棄** → データが残っている

**対策**:
- Raspberry Piを物理的に安全な場所に保管
- SSHのパスワードを強固にする
- 使用後はデータを削除

---

## 📞 プライバシーに関する問い合わせ

プライバシーについて質問や懸念がある場合:

1. **GitHubのIssue**: https://github.com/sakaguchiii/tatekaezamurai-bot/issues
2. **ドキュメントを確認**: このファイル、および `SQLiteデータベース_確認ガイド.md`

---

## ✅ 結論

**清算くんは、プライバシーに配慮して設計されています。**

- ✅ トーク内容はデータベースに保存しない
- ✅ 必要最小限のデータのみ保存
- ✅ ローカル（Raspberry Pi）のみで動作
- ✅ いつでもデータを削除可能

**ただし**:
- ⚠️ ログには一時的に記録される
- ⚠️ データベースは暗号化されていない
- ⚠️ Raspberry Piにアクセスできる人はすべてのデータを見られる

---

**透明性を保ち、ユーザーのプライバシーを尊重することが重要です。** 🔐
