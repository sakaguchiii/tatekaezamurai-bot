# デプロイ前チェックリスト（Raspberry Pi）

## ⚠️ 必ずこの順番で確認してください

### 1️⃣ ローカル環境での最終確認 ✅

- [x] TypeScriptビルドが成功する
- [x] 型エラーがない
- [x] 不要なファイル・ディレクトリを削除済み
- [x] .gitignoreが適切に設定されている
- [x] ドキュメントが最新

### 2️⃣ Raspberry Pi環境の準備 📝

実施前に以下を確認：

```bash
# Node.jsバージョン確認（v18以上推奨）
node -v

# ビルドツールの確認
which gcc
which python3

# ビルドツールがない場合はインストール
sudo apt-get update
sudo apt-get install -y build-essential python3
```

### 3️⃣ デプロイ実行 🚀

```bash
# 1. 現在のサーバーを停止
pm2 stop all

# 2. バックアップ作成（念のため）
cd ~/tatekaezamurai-bot/server
npm run export-json
# → backups/sessions_export_all_YYYY-MM-DD.json が作成される

# 3. 最新コードを取得
cd ~/tatekaezamurai-bot
git checkout main
git pull origin feature/sqlite-migration
# または
git checkout feature/sqlite-migration
git pull

# 4. 依存関係インストール（better-sqlite3のビルドを含む）
cd server
npm install

# ⚠️ ここでエラーが出る場合：
# npm rebuild better-sqlite3
# それでもダメな場合：
# npm install -g node-gyp
# npm rebuild better-sqlite3

# 5. ビルド
npm run build

# 6. 起動前確認
ls -la dist/services/
# backupService.js, cacheService.js, databaseService.js が存在すること

# 7. サーバー起動
pm2 restart all

# 8. ログ確認（重要！）
pm2 logs --lines 100
```

### 4️⃣ 初回起動時の確認 👀

**ログに以下が表示されるはず：**

```
✅ 環境変数を確認しました
🗄️ SQLiteデータベース接続完了: /home/pi/tatekaezamurai-bot/server/src/data/database.db
✅ データベーススキーマを初期化しました
💾 キャッシュサービスを初期化しました
📁 バックアップディレクトリを作成: ...

📦 JSONからSQLiteへの移行を開始 (X セッション)  ← これが表示されれば移行実行中
✅ 移行完了

🚀 サーバーが起動しました ポート: 3000
⏰ 自動バックアップを開始します
📅 スケジュール: 0 3 * * * (毎日午前3時)
```

### 5️⃣ ファイル確認 📁

```bash
# データベースファイルが作成されているか
ls -la ~/tatekaezamurai-bot/server/src/data/
# → database.db が存在するはず

# バックアップディレクトリが作成されているか
ls -la ~/tatekaezamurai-bot/server/src/data/backups/
# → sessions_YYYY-MM-DD.json が存在するはず（移行完了後）
```

### 6️⃣ 動作確認 🧪

LINEアプリで以下をテスト：

1. **セッション開始**
   ```
   あなた: 開始
   Bot: 清算くん開始！
        ⚡️現在の参加者：1名
        ・[あなたの名前]さん
   ```

2. **参加**
   ```
   友達: 参加
   Bot: [友達の名前]さんが参加しました！
        現在の参加者：2名
   ```

3. **支払い記録**
   ```
   あなた: 一軒目 5000
   Bot: ✅ 一軒目 5,000円 記録！
   ```

4. **状況確認**
   ```
   あなた: 状況
   Bot: 📊 現在の状況
        合計: 5,000円
        ...
   ```

5. **清算**
   ```
   あなた: 清算
   Bot: 💰 清算結果
        ...
   ```

6. **終了**
   ```
   あなた: 終了
   Bot: 🏁 セッションを終了しました
   ```

### 7️⃣ パフォーマンス確認 ⚡

```bash
# ログで応答時間を確認
pm2 logs | grep "ms"

# 期待値：
# - セッション作成: <100ms
# - 支払い記録: <50ms
# - 清算計算: <200ms
```

### 8️⃣ 問題が発生した場合 🆘

#### ケース1: better-sqlite3のビルドエラー

```bash
# 解決策1: ビルドツールを確認
sudo apt-get install -y build-essential python3

# 解決策2: node-gypを再インストール
npm install -g node-gyp
cd ~/tatekaezamurai-bot/server
npm rebuild better-sqlite3

# 解決策3: Node.jsバージョンを確認
node -v
# v18以上が推奨。古い場合はNode.jsをアップグレード
```

#### ケース2: 移行が実行されない

```bash
# 原因確認
ls -la ~/tatekaezamurai-bot/server/src/data/sessions.json

# sessions.jsonが存在しない場合：
# → 移行対象がないため正常（新規インストール）

# sessions.jsonが存在するのに移行されない場合：
# → ログを確認
pm2 logs | grep "移行"
```

#### ケース3: サーバーが起動しない

```bash
# エラーログを確認
pm2 logs --err

# 一般的な原因：
# 1. ポート3000が使用中
sudo lsof -i :3000

# 2. 環境変数(.env)が設定されていない
cat ~/tatekaezamurai-bot/server/.env

# 3. 依存関係のインストール失敗
cd ~/tatekaezamurai-bot/server
npm install
```

#### ケース4: データが消えた！

**落ち着いてください。バックアップがあります。**

```bash
# バックアップを確認
ls -la ~/tatekaezamurai-bot/server/src/data/backups/

# 最新のバックアップから復元
cd ~/tatekaezamurai-bot/server
# 最新のバックアップファイルをsessions.jsonにコピー
cp src/data/backups/sessions_YYYY-MM-DD.json src/data/sessions.json

# サーバー再起動（自動的に再移行される）
pm2 restart all
```

### 9️⃣ 正常動作の確認 ✅

以下がすべて確認できたらデプロイ成功：

- [ ] pm2 status で「online」状態
- [ ] ログにエラーがない
- [ ] database.db が作成されている
- [ ] LINEで「開始」コマンドが動作する
- [ ] 支払い記録が正常に保存される
- [ ] 「清算」コマンドが正常に動作する
- [ ] データが永続化される（サーバー再起動後も残る）

### 🔟 デプロイ後の監視 📊

```bash
# リアルタイムログ監視
pm2 logs

# メモリ・CPU使用率確認
pm2 monit

# 定期的にデータベースサイズを確認
ls -lh ~/tatekaezamurai-bot/server/src/data/database.db

# バックアップが毎日作成されているか確認（翌日以降）
ls -la ~/tatekaezamurai-bot/server/src/data/backups/
```

---

## 📞 問題が解決しない場合

1. **ログをすべて保存**
   ```bash
   pm2 logs --lines 500 > error_log.txt
   ```

2. **システム情報を記録**
   ```bash
   node -v > system_info.txt
   npm -v >> system_info.txt
   uname -a >> system_info.txt
   cat /etc/os-release >> system_info.txt
   ```

3. **GitHubにIssueを作成** または **開発者に連絡**

---

**このチェックリストを完了してから本番環境にデプロイしてください！**
