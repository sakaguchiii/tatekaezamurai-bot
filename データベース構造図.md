# ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ å›³

**æœ€çµ‚æ›´æ–°**: 2026å¹´1æœˆ23æ—¥

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€æ¸…ç®—ãã‚“ã®SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹é€ ã‚’è¦–è¦šçš„ã«ç¤ºã—ã¾ã™ã€‚

---

## ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

### 1. sessions ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   sessions                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚«ãƒ©ãƒ å     â”‚ å‹       â”‚ èª¬æ˜                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚ TEXT     â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰      â”‚
â”‚ group_id     â”‚ TEXT     â”‚ LINEã‚°ãƒ«ãƒ¼ãƒ—ID            â”‚
â”‚ status       â”‚ TEXT     â”‚ active/settled/completed  â”‚
â”‚ created_at   â”‚ TEXT     â”‚ ä½œæˆæ—¥æ™‚ï¼ˆISO8601ï¼‰        â”‚
â”‚ updated_at   â”‚ TEXT     â”‚ æ›´æ–°æ—¥æ™‚ï¼ˆISO8601ï¼‰        â”‚
â”‚ data         â”‚ TEXT     â”‚ å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
  â”œâ”€ idx_sessions_group (group_id)   â† é«˜é€Ÿæ¤œç´¢
  â”œâ”€ idx_sessions_status (status)    â† ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢
  â””â”€ idx_sessions_created (created_at) â† æ—¥ä»˜åˆ¥æ¤œç´¢
```

#### åˆ¶ç´„ï¼ˆCHECKåˆ¶ç´„ï¼‰
```sql
status IN ('active', 'settled', 'completed')
```
â†’ ã“ã‚Œä»¥å¤–ã®å€¤ã¯å…¥ã‚‰ãªã„

---

### 2. analytics_events ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåˆ†æç”¨ãƒ»å°†æ¥ã®æ‹¡å¼µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               analytics_events                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚«ãƒ©ãƒ å     â”‚ å‹       â”‚ èª¬æ˜                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚ INTEGER  â”‚ ã‚¤ãƒ™ãƒ³ãƒˆIDï¼ˆè‡ªå‹•æ¡ç•ªï¼‰     â”‚
â”‚ event_type   â”‚ TEXT     â”‚ ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡              â”‚
â”‚ group_id     â”‚ TEXT     â”‚ LINEã‚°ãƒ«ãƒ¼ãƒ—IDï¼ˆä»»æ„ï¼‰    â”‚
â”‚ user_id      â”‚ TEXT     â”‚ LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä»»æ„ï¼‰    â”‚
â”‚ session_id   â”‚ TEXT     â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆä»»æ„ï¼‰      â”‚
â”‚ amount       â”‚ INTEGER  â”‚ é‡‘é¡ï¼ˆä»»æ„ï¼‰              â”‚
â”‚ label        â”‚ TEXT     â”‚ ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰            â”‚
â”‚ created_at   â”‚ TEXT     â”‚ ä½œæˆæ—¥æ™‚ï¼ˆISO8601ï¼‰       â”‚
â”‚ metadata     â”‚ TEXT     â”‚ ãã®ä»–æƒ…å ±ï¼ˆJSONã€ä»»æ„ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
  â”œâ”€ idx_analytics_type (event_type)
  â”œâ”€ idx_analytics_created (created_at)
  â”œâ”€ idx_analytics_user (user_id)
  â””â”€ idx_analytics_group (group_id)
```

#### ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®ä¾‹
- `payment`: æ”¯æ‰•ã„è¨˜éŒ²
- `settle`: ç²¾ç®—å®Ÿè¡Œ
- `start`: ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
- `end`: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
- `join`: ãƒ¡ãƒ³ãƒãƒ¼å‚åŠ 

---

## ğŸ“¦ data ã‚«ãƒ©ãƒ ã®ä¸­èº«ï¼ˆJSONæ§‹é€ ï¼‰

`sessions.data` ã«ã¯ã€**ã™ã¹ã¦ã®æƒ…å ±**ãŒJSONå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

### å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ä¾‹

```json
{
  "groupId": "C48819908d9907fd29bf67958dc6de9f7",
  "status": "settled",
  "createdAt": "2026-01-22T13:45:00.000Z",
  "members": [
    {
      "userId": "Ucdc6f609c888a5de55a124e70aa68d6d",
      "displayName": "å¤ªéƒ"
    },
    {
      "userId": "U12345678abcdef1234567890abcdef1",
      "displayName": "èŠ±å­"
    },
    {
      "userId": "U98765432fedcba0987654321fedcba0",
      "displayName": "æ¬¡éƒ"
    }
  ],
  "payments": [
    {
      "venue": "1è»’ç›®",
      "amount": 5000,
      "timestamp": "2026-01-22T13:50:00.000Z",
      "paidBy": "å¤ªéƒ"
    },
    {
      "venue": "2è»’ç›®",
      "amount": 8000,
      "timestamp": "2026-01-22T14:30:00.000Z",
      "paidBy": "èŠ±å­"
    }
  ],
  "settlement": {
    "totalAmount": 13000,
    "perPerson": 4333,
    "transactions": [
      {
        "from": "æ¬¡éƒ",
        "to": "å¤ªéƒ",
        "amount": 1667
      },
      {
        "from": "æ¬¡éƒ",
        "to": "èŠ±å­",
        "amount": 2666
      }
    ]
  }
}
```

### JSONã®æ§‹é€ å›³

```
sessions.data (JSON)
â”‚
â”œâ”€ groupId (string)           # LINEã‚°ãƒ«ãƒ¼ãƒ—ID
â”œâ”€ status (string)            # active/settled/completed
â”œâ”€ createdAt (string)         # ISO8601å½¢å¼ã®æ—¥æ™‚
â”‚
â”œâ”€ members (array)            # ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§
â”‚   â”œâ”€ [0]
â”‚   â”‚   â”œâ”€ userId (string)
â”‚   â”‚   â””â”€ displayName (string)
â”‚   â”œâ”€ [1]
â”‚   â”‚   â”œâ”€ userId (string)
â”‚   â”‚   â””â”€ displayName (string)
â”‚   â””â”€ ...
â”‚
â”œâ”€ payments (array)           # æ”¯æ‰•ã„å±¥æ­´
â”‚   â”œâ”€ [0]
â”‚   â”‚   â”œâ”€ venue (string)     # "1è»’ç›®", "2è»’ç›®"ãªã©
â”‚   â”‚   â”œâ”€ amount (number)    # é‡‘é¡
â”‚   â”‚   â”œâ”€ timestamp (string) # ISO8601
â”‚   â”‚   â””â”€ paidBy (string)    # æ”¯æ‰•ã„è€…ï¼ˆä»»æ„ï¼‰
â”‚   â”œâ”€ [1]
â”‚   â”‚   â””â”€ ...
â”‚   â””â”€ ...
â”‚
â””â”€ settlement (object)        # ç²¾ç®—çµæœï¼ˆä»»æ„ï¼‰
    â”œâ”€ totalAmount (number)   # åˆè¨ˆé‡‘é¡
    â”œâ”€ perPerson (number)     # 1äººã‚ãŸã‚Š
    â””â”€ transactions (array)   # èª°ãŒèª°ã«ã„ãã‚‰æ‰•ã†
        â”œâ”€ [0]
        â”‚   â”œâ”€ from (string)
        â”‚   â”œâ”€ to (string)
        â”‚   â””â”€ amount (number)
        â””â”€ ...
```

---

## ğŸ”— ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®é–¢ä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    sessions     â”‚
â”‚  (ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ group_id, session_id ã§é–¢é€£
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚analytics_events â”‚
â”‚   (åˆ†æç”¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„**: ç¾åœ¨ã¯å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã—ï¼ˆæŸ”è»Ÿæ€§å„ªå…ˆï¼‰

---

## ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚

```
LINEã§ã€Œé–‹å§‹ã€
    â†“
commandHandler.ts
    â†“
storageService.saveSession()
    â†“
cacheService (ãƒ¡ãƒ¢ãƒªã«ä¿å­˜)
    â†“
databaseService (SQLiteã«ä¿å­˜)
    â†“
INSERT INTO sessions (id, group_id, status, created_at, updated_at, data)
VALUES ('C488...', 'C488...', 'active', '2026-01-22...', '2026-01-22...', '{...}')
```

### 2. æ”¯æ‰•ã„è¿½åŠ æ™‚

```
LINEã§ã€Œ1è»’ç›® 5000ã€
    â†“
commandHandler.ts
    â†“
session.payments.push({venue: "1è»’ç›®", amount: 5000, ...})
    â†“
storageService.saveSession(session)
    â†“
cacheService (ãƒ¡ãƒ¢ãƒªæ›´æ–°)
    â†“
databaseService (SQLiteæ›´æ–°)
    â†“
UPDATE sessions
SET data = '{...updated...}', updated_at = '2026-01-22...'
WHERE id = 'C488...'
```

### 3. ç²¾ç®—æ™‚

```
LINEã§ã€Œç²¾ç®—ã€
    â†“
è¨ˆç®—å‡¦ç†
    â†“
session.settlement = {...}
session.status = 'settled'
    â†“
storageService.saveSession(session)
    â†“
UPDATE sessions
SET status = 'settled', data = '{...}', updated_at = '...'
WHERE id = 'C488...'
```

---

## ğŸ” ã‚ˆãä½¿ã†SQLãƒ‘ã‚¿ãƒ¼ãƒ³

### ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—

```sql
SELECT data
FROM sessions
WHERE group_id = 'C48819908d9907fd29bf67958dc6de9f7'
  AND status IN ('active', 'settled')
ORDER BY updated_at DESC
LIMIT 1;
```
â†’ ã“ã‚ŒãŒã‚¢ãƒ—ãƒªã§å®Ÿè¡Œã•ã‚Œã‚‹ä¸»ãªã‚¯ã‚¨ãƒª

### JSONå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

```sql
-- ãƒ¡ãƒ³ãƒãƒ¼æ•°ã‚’å–å¾—
SELECT
  id,
  json_array_length(data, '$.members') as member_count
FROM sessions;

-- æ”¯æ‰•ã„ç·é¡ã‚’å–å¾—
SELECT
  id,
  json_extract(data, '$.settlement.totalAmount') as total
FROM sessions
WHERE status = 'settled';
```

---

## ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®ç›®å®‰

### 1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Š

```
ãƒ¡ãƒ³ãƒãƒ¼: 5äºº
æ”¯æ‰•ã„: 3è»’
ç²¾ç®—æ¸ˆã¿

â†’ JSON ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ç´„2KB
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ä½“

```
100ã‚»ãƒƒã‚·ãƒ§ãƒ³ â†’ ç´„200KB
1,000ã‚»ãƒƒã‚·ãƒ§ãƒ³ â†’ ç´„2MB
10,000ã‚»ãƒƒã‚·ãƒ§ãƒ³ â†’ ç´„20MB
```

**Raspberry Piã§ã‚‚ååˆ†ãªå®¹é‡ï¼**

---

## ğŸ—‚ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
server/dist/data/
â”‚
â”œâ”€â”€ database.db           # ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆç´„2MBï¼‰
â”œâ”€â”€ database.db-wal       # Write-Ahead Logï¼ˆå¤‰æ›´å·®åˆ†ï¼‰
â”œâ”€â”€ database.db-shm       # å…±æœ‰ãƒ¡ãƒ¢ãƒªï¼ˆãƒ­ãƒƒã‚¯ç®¡ç†ï¼‰
â”‚
â””â”€â”€ backups/             # è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONå½¢å¼ï¼‰
    â”œâ”€â”€ sessions_2026-01-22.json
    â”œâ”€â”€ sessions_2026-01-21.json
    â””â”€â”€ ...ï¼ˆ7æ—¥åˆ†ä¿æŒï¼‰
```

---

## ğŸ¯ ãªãœã“ã®æ§‹é€ ï¼Ÿ

### 1. JSONã‚’data ã‚«ãƒ©ãƒ ã«ä¿å­˜ã™ã‚‹ç†ç”±

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… æŸ”è»Ÿæ€§ãŒé«˜ã„ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ãŒç°¡å˜ï¼‰
- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå°‘ãªã„
- âœ… æ—¢å­˜ã®JSONæ§‹é€ ã‚’ãã®ã¾ã¾ä½¿ãˆã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ JSONå†…ã®æ¤œç´¢ãŒã‚„ã‚„é…ã„ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸å¯ï¼‰
- âš ï¸ å‹ãƒã‚§ãƒƒã‚¯ãŒãªã„

**åˆ¤æ–­**: æ¸…ç®—ãã‚“ã¯æ¤œç´¢é »åº¦ãŒä½ãã€æŸ”è»Ÿæ€§ã‚’é‡è¦–ã™ã‚‹ãŸã‚ã€ã“ã®æ§‹é€ ãŒæœ€é©

### 2. analytics_events ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ†ã‘ã‚‹ç†ç”±

- å°†æ¥çš„ã«è©³ç´°ãªåˆ†æã‚’ã—ãŸã„
- JSONå†…ã«ãƒ­ã‚°ã‚’å…¥ã‚Œã‚‹ã¨è‚¥å¤§åŒ–ã™ã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆå˜ä½ã§ã®ã‚¯ã‚¨ãƒªãŒé«˜é€Ÿ

---

## ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

```bash
# ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’è§£æ”¾
sqlite3 dist/data/database.db "VACUUM;"

# WALãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ¼ã‚¸
sqlite3 dist/data/database.db "PRAGMA wal_checkpoint(TRUNCATE);"
```

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ•´åˆæ€§ç¢ºèª
sqlite3 dist/data/database.db "PRAGMA integrity_check;"

# å‡ºåŠ›: ok
```

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- **SQLiteå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: https://www.sqlite.org/
- **JSON1æ‹¡å¼µ**: https://www.sqlite.org/json1.html
- **WALãƒ¢ãƒ¼ãƒ‰**: https://www.sqlite.org/wal.html

---

**ã“ã®æ§‹é€ ã‚’ç†è§£ã™ã‚Œã°ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è‡ªç”±ã«æ“ä½œã§ãã¾ã™ï¼** ğŸ—„ï¸
