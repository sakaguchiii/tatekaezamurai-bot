# 修正履歴 2025-01-22

## 🐛 バグ修正: SQLite構文エラー

### 問題
Raspberry Pi上で`npm run export-json`を実行すると以下のエラーが発生：

```
SqliteError: no such column: "active" - should this be a string literal in single-quotes?
```

### 原因

#### 1. databaseService.ts（行40）
SQLiteでは文字列リテラルに**シングルクォート**を使う必要があるが、ダブルクォートを使用していた。

**修正前**:
```typescript
'SELECT data FROM sessions WHERE group_id = ? AND status IN ("active", "settled") ...'
```

**修正後**:
```typescript
'SELECT data FROM sessions WHERE group_id = ? AND status IN (\'active\', \'settled\') ...'
```

#### 2. export-json.ts
- データが0件の場合、`success`フラグが`false`のまま返却されていた
- `--stats`オプション使用時に明示的に`exit(0)`を呼んでいなかった

**修正箇所1（行59-60）**:
```typescript
if (result.totalSessions === 0) {
  console.log('⚠️ エクスポートするセッションがありません');
  result.success = true; // エラーではない ← 追加
  return result;
}
```

**修正箇所2（行192-194）**:
```typescript
if (showStats) {
  showStatistics();
  process.exit(0); // ← 追加
}
```

---

## ✅ 修正後の動作確認

### ローカル環境（Mac）

```bash
# すべて正常終了（exit 0）を確認
✅ npm run export-json
✅ npm run export-json:stats
✅ npm run export-json:active
✅ npm run migrate:dry-run
✅ npm run verify-migration
```

---

## 🚀 Raspberry Piでの確認手順

### 1. 最新コードを取得

```bash
cd ~/tatekaezamurai-bot
git pull origin feature/sqlite-migration
```

### 2. ビルド

```bash
cd server
npm run build
```

### 3. スクリプトのテスト

```bash
# 統計情報表示（データがない場合は0件と表示される）
npm run export-json:stats

# エクスポート実行（データがない場合は警告のみ）
npm run export-json

# マイグレーションのドライラン
npm run migrate:dry-run
```

**期待される結果**:
- すべてのコマンドがエラーなく終了する
- データが0件の場合は警告メッセージが表示されるが、エラーではない

### 4. サーバー起動

```bash
pm2 restart all
pm2 logs
```

**ログで確認すべき内容**:
```
✅ 環境変数を確認しました
🗄️ SQLiteデータベース接続完了: ...
✅ データベーススキーマを初期化しました
💾 キャッシュサービスを初期化しました
🚀 サーバーが起動しました ポート: 3000
⏰ 自動バックアップを開始します
```

### 5. LINEでの動作確認

1. 「開始」→ セッション作成
2. 「参加」→ メンバー追加
3. 「一軒目 5000」→ 支払い記録
4. 「状況」→ セッション確認
5. 「清算」→ 清算計算
6. 「終了」→ セッション終了

すべてが正常に動作すればOK！

---

## 📝 技術メモ

### SQLiteの文字列リテラル

SQLiteでは：
- **シングルクォート `'`**: 文字列リテラル
- **ダブルクォート `"`**: 識別子（カラム名など）

```sql
-- 正しい
SELECT * FROM sessions WHERE status = 'active';

-- 間違い（カラム"active"を探そうとする）
SELECT * FROM sessions WHERE status = "active";
```

### スクリプトの終了コード

- `exit(0)`: 正常終了
- `exit(1)`: エラー終了

データが0件の場合は「警告」であって「エラー」ではないので、`exit(0)`が正しい。

---

## 🔗 関連コミット

- `f803b1b`: fix: SQLite構文エラーとスクリプト終了コードを修正

---

## ✅ チェックリスト

- [x] ローカル環境で修正確認
- [x] ビルド成功
- [x] GitHubにpush
- [ ] Raspberry Piで動作確認（次のステップ）

---

**Raspberry Piでの確認後、問題なければmainブランチにマージしてください。**
