# 清算くん 修正履歴（2026年1月18日）

## 概要

実際の使用で発見されたバグと改善点を修正しました。

---

## 🔴 修正したバグ

### 1. **金額パースの致命的なバグ**

**問題:**
- 「一軒目 2000円」が「200円」として記録される
- 正規表現の評価順序の問題

**原因:**
```typescript
// 修正前
const regex = /^([一二三四1234]軒目|追加)\s*(\d{1,3}(?:,\d{3})*|\d+)円?/;
```
- `\d{1,3}(?:,\d{3})*` が先に評価される
- 「2000」の最初の「200」にマッチして終了
- OR演算子の右側 `\d+` が評価されない

**修正内容:**
```typescript
// 修正後
const regex = /^(.+?)[\s　]+([\d,]+)円?$/;
```
- より柔軟なパターンに変更
- 任意のラベル名 + スペース + 数字（カンマ含む） + 円（オプション）
- 半角・全角スペース両対応

**ファイル:** `server/src/utils/parser.ts:8-29`

---

### 2. **参加者カウントが不正確**

**問題:**
- グループメンバー数が固定値10人として計算される
- 実際の参加人数と異なるため、1人あたりの金額が間違う

**原因:**
```typescript
// 修正前
const memberCount = 10; // グループ人数は取得できないため固定値を使用
```

**修正内容:**
- 固定値を削除
- 支払いを記録した人を自動的にメンバーに追加する仕組みを明確化
- `session.members.length` で実際の参加人数を使用

**ファイル:** `server/src/handlers/commandHandler.ts:91-105`

---

## 🟡 改善した機能

### 3. **コマンドエイリアスの追加**

**改善内容:**
ユーザーフレンドリーなコマンド入力を実現

| コマンド | 追加されたエイリアス |
|---------|-------------------|
| 開始 | はじめ, start |
| 清算 | せいさん, 精算, settle |
| 状況 | 確認, じょうきょう, status |
| キャンセル | きゃんせる, 取消, cancel |
| ヘルプ | へるぷ, 使い方, help, ? |
| 終了 | しゅうりょう, おわり, end |

**実装:**
- `toLowerCase()` で大文字・小文字を区別しない
- ひらがな・カタカナ・漢字・英語すべてに対応

**ファイル:** `server/src/utils/parser.ts:2-58`

---

### 4. **支払いラベルの柔軟化**

**改善前:**
- 「一軒目」「二軒目」「三軒目」「四軒目」のみ

**改善後:**
- 任意のラベル名が使用可能

**使用例:**
```
一軒目 14000円          ← 従来通り
ラーメン 500円          ← NEW
タクシー代 3000         ← NEW
カラオケ 5,000円        ← NEW
二次会 8000             ← NEW
```

**ファイル:** `server/src/utils/parser.ts:8-29`

---

### 5. **全角スペース対応**

**改善内容:**
- ラベルと金額の間のスペースを半角・全角両対応

**対応パターン:**
```
一軒目 2000円   ← 半角スペース OK
一軒目　2000円  ← 全角スペース OK
```

**実装:**
```typescript
const regex = /^(.+?)[\s　]+([\d,]+)円?$/;
//                    ↑ \sは半角スペース、　は全角スペース
```

**ファイル:** `server/src/utils/parser.ts:13`

---

### 6. **ヘルプメッセージの改善**

**改善内容:**
- ウェルカムメッセージとの表記統一
- エイリアスコマンドを明記
- 柔軟な記録例を追加
- 架空のサポートメールアドレスを削除

**修正前:**
```
【コマンド一覧】
・開始 - セッション開始
・一軒目 XXXX円 - 支払い記録
・清算 - 精算結果表示
...

【お問い合わせ】
support@tatekaezamurai.com
```

**修正後:**
```
【コマンド一覧】
☑︎ 開始 / はじめ - セッション開始
☑︎ 状況 / 確認 - 現在の記録確認
☑︎ 清算 / せいさん - 精算結果表示
...

【記録例】
一軒目 14000円
ラーメン 500
タクシー代 3,000円
カラオケ 5000
```

**ファイル:** `server/src/utils/formatter.ts:121-151`

---

## 📝 その他の変更

### 開始メッセージの改善

**変更内容:**
- 参加者の自動追加の仕組みを説明
- 記録例を具体的に表示
- 「たてかえ侍」→「清算くん」に表記統一

**ファイル:** `server/src/handlers/commandHandler.ts:129-143`

---

## 📊 修正ファイル一覧

| ファイル | 修正内容 |
|---------|---------|
| `server/src/utils/parser.ts` | 金額パース修正、コマンドエイリアス追加、全角スペース対応 |
| `server/src/handlers/commandHandler.ts` | 参加者カウント修正、開始メッセージ改善 |
| `server/src/utils/formatter.ts` | ヘルプメッセージ改善 |

---

## ✅ テスト項目

修正後、以下をテストしてください：

### 金額パースのテスト
- [ ] 「一軒目 2000円」 → 2000円として記録される
- [ ] 「ラーメン 500」 → 500円として記録される
- [ ] 「タクシー　3000円」（全角スペース） → 3000円として記録される
- [ ] 「カラオケ 5,000」（カンマ区切り） → 5000円として記録される

### コマンドエイリアスのテスト
- [ ] 「はじめ」でセッション開始
- [ ] 「せいさん」で清算結果表示
- [ ] 「確認」で状況確認
- [ ] 「?」でヘルプ表示

### 参加者カウントのテスト
- [ ] 2人で支払い記録 → 1人あたりの金額が正しく計算される
- [ ] 3人で支払い記録 → 1人あたりの金額が正しく計算される

---

## 🚀 デプロイ手順

Raspberry Piで以下を実行：

```bash
# サーバー停止
pm2 stop tatekaezamurai

# 最新コードを取得
cd ~/tatekaezamurai-bot
git pull origin main

# ビルド
cd server
npm run build

# サーバー再起動
pm2 restart tatekaezamurai

# ログ確認
pm2 logs tatekaezamurai --lines 20
```

---

## 📌 今後の改善案

### 未対応の問題
1. ~~グループ全員を一度に取得する方法~~ → LINE API制限により困難
2. ~~送金完了の記録機能~~ → 次回実装予定
3. ~~リマインダー機能~~ → 次回実装予定

### 検討中の機能
- 途中参加・途中退出の対応
- 人数を手動で指定する機能
- 特定のメンバーだけ除外する機能

---

## 🎉 まとめ

**修正したバグ:** 2件
- 金額パースの致命的なバグ（2000円→200円）
- 参加者カウントの不正確さ

**追加した機能:** 4件
- コマンドエイリアス（各コマンド2-5個の別名）
- 支払いラベルの柔軟化（任意のラベル名）
- 全角スペース対応
- ヘルプメッセージの改善

すべての修正により、ユーザビリティが大幅に向上しました。
