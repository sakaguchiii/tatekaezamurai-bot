# 清算くん 現在の仕様書 v2026.01.19

このドキュメントは、清算くん（たてかえ侍bot）の現在の仕様を詳しく解説します。

---

## 📋 目次

1. [概要](#概要)
2. [基本的な使い方](#基本的な使い方)
3. [コマンド一覧](#コマンド一覧)
4. [計算ロジック](#計算ロジック)
5. [データ構造](#データ構造)
6. [システム構成](#システム構成)
7. [制限事項](#制限事項)

---

## 概要

### プロジェクト名
**清算くん（たてかえ侍bot）**

### 目的
飲み会などのグループでの立替金の精算を自動化するLINEボット

### 対象
LINEグループ専用（1対1のトークでは動作しません）

### 技術スタック
- **バックエンド**: Node.js + TypeScript + Express
- **LINE SDK**: @line/bot-sdk v9
- **ストレージ**: JSON ファイル（ローカル）
- **デプロイ先**: Raspberry Pi + ngrok
- **プロセス管理**: pm2

---

## 基本的な使い方

### 1. ボットをグループに追加

グループにボットを追加すると、ウェルカムメッセージが表示されます。

```
⚡️ 精算くんです！

グループ専用の割り勘ボットです

使い方:
1️⃣「開始」
2️⃣ 全員「参加」
3️⃣ 支払い記録
4️⃣「清算」

詳しくは「ヘルプ」
```

### 2. セッションを開始

誰かが「開始」と入力すると、セッションが開始されます。

```
【ユーザー】開始

【Bot】
🍻 清算くん開始！

参加者: 1名
・太郎さん

⚠️ 参加する人は「参加」と入力してね！

記録は「場所 金額」で入力！
例： 一軒目 5000
```

### 3. 全員が参加登録

参加する人全員が「参加」と入力します。

```
【ユーザー】参加

【Bot】
参加者: 2名
太郎, 花子
```

### 4. 支払いを記録

支払いを立て替えた人が「場所 金額」の形式で入力します。

```
【ユーザー】一軒目 5000

【Bot】
✅ 一軒目 5000円 記録しました！
```

### 5. 精算結果を表示

「清算」と入力すると、精算結果が表示されます。

```
【ユーザー】清算

【Bot】
💰 精算結果

合計: 12000円
1人: 4000円 × 3名

【送金】
花子 → 太郎
💴 1000円

三郎 → 太郎
💴 3000円
```

### 6. セッションを終了

「終了」と入力すると、セッションが終了します。

```
【ユーザー】終了

【Bot】
OK！これにて終了！
```

---

## コマンド一覧

### 基本コマンド

| コマンド | エイリアス | 説明 | 使用例 |
|---------|----------|------|--------|
| **開始** | はじめ, start | セッションを開始 | `開始` |
| **参加** | さんか, join | 参加者として登録 | `参加` |
| **清算** | せいさん, 精算, settle | 精算結果を表示 | `清算` |
| **状況** | 確認, じょうきょう, status | 現在の記録を確認 | `状況` |
| **終了** | しゅうりょう, おわり, end | セッションを終了 | `終了` |
| **ヘルプ** | へるぷ, 使い方, help | ヘルプを表示 | `ヘルプ` |
| **キャンセル** | きゃんせる, 取消, cancel | 最後の記録を削除 | `キャンセル` |

### 支払い記録コマンド

**形式:** `<ラベル> <金額>`

**例:**
```
一軒目 5000
ラーメン 500
タクシー 3000
カラオケ 5,000円
二次会 8000
```

**対応パターン:**
- ✅ 半角スペース: `一軒目 5000`
- ✅ 全角スペース: `一軒目　5000`
- ✅ カンマ区切り: `一軒目 5,000`
- ✅ 円記号あり: `一軒目 5000円`
- ✅ 任意のラベル: `タクシー代 3000`

---

## 計算ロジック

### 基本的な計算方法（人間の計算方法）

清算くんは、人間が手計算するときと同じ方法で計算します。

#### ステップ1: 合計金額を計算

すべての支払いを合計します。

```
太郎: 5000円
花子: 7000円
合計: 12000円
```

#### ステップ2: 1人あたりの金額を計算

合計金額を参加人数で割ります（切り捨て）。

```
12000円 ÷ 3人 = 4000円
```

#### ステップ3: 余り（端数）を計算

```
余り = 12000 - (4000 × 3) = 0円
```

#### ステップ4: 各人の負担額を設定

全員が1人あたりの金額を負担します。

```
太郎: 4000円
花子: 4000円
三郎: 4000円
```

#### ステップ5: 余りを最も多く支払った人に負担させる

端数が出る場合は、最も多く支払った人が負担します。

**例: 5000円を3人で割る場合**
```
5000円 ÷ 3人 = 1666円（余り2円）

太郎（最も多く支払った人）: 1666 + 2 = 1668円
花子: 1666円
三郎: 1666円

合計: 1668 + 1666 + 1666 = 5000円 ✅
```

#### ステップ6: 各人の収支を計算

```
収支 = 支払った額 - 負担額

太郎: 5000 - 4000 = +1000円（もらう）
花子: 7000 - 4000 = +3000円（もらう）
三郎: 0 - 4000 = -4000円（払う）
```

#### ステップ7: 送金パターンを計算（貪欲法）

最も効率的な送金パターンを計算します。

```
三郎 → 太郎: 1000円
三郎 → 花子: 3000円
```

### メリット

✅ **誤差ゼロ**: 支払い合計と負担合計が完全に一致
✅ **人間の感覚と一致**: 「合計を人数で割る」という自然な計算
✅ **多くの場合、端数が出ない**: 飲み会は大体キリの良い額になる

---

## データ構造

### Session（セッション）

グループの清算セッション情報を保持します。

```typescript
{
  groupId: string;           // LINEグループID
  groupName: string;         // グループ名
  createdAt: string;         // 作成日時（ISO 8601）
  updatedAt: string;         // 更新日時（ISO 8601）
  createdBy: {               // セッション作成者
    userId: string;
    displayName: string;
  };
  status: 'active' | 'settled' | 'ended';  // ステータス
  members: Member[];         // 参加者リスト
  payments: Payment[];       // 支払い記録リスト
  settlements: Settlement[]; // 精算結果リスト
  reminder: {
    enabled: boolean;
    count: number;
  };
}
```

### Member（メンバー）

参加者情報を保持します。

```typescript
{
  userId: string;            // LINEユーザーID
  displayName: string;       // 表示名
  pictureUrl: string;        // プロフィール画像URL
  joinedAt: string;          // 参加日時（ISO 8601）
  participationRange: {      // 参加範囲（途中参加対応用）
    startFrom: number;       // 何番目の支払いから参加か
    endAt: number | null;    // 何番目の支払いまで参加か
  };
}
```

**注意:** 現在、`participationRange`は記録されますが、計算には使用されていません（全員が全ての支払いを負担します）。

### Payment（支払い）

支払い記録情報を保持します。

```typescript
{
  id: string;                // 支払いID（例: payment_1234567890）
  sequence: number;          // 支払いの順序（0始まり）
  label: string;             // ラベル（例: 一軒目）
  amount: number;            // 金額（円）
  paidBy: {                  // 立替者
    userId: string;
    displayName: string;
  };
  participants: string[];    // 参加者のuserIdリスト
  timestamp: string;         // 記録日時（ISO 8601）
  isDeleted: boolean;        // 削除フラグ（キャンセル用）
}
```

### Balance（収支）

各メンバーの収支情報を保持します（計算結果）。

```typescript
{
  userId: string;            // LINEユーザーID
  displayName: string;       // 表示名
  paid: number;              // 支払った合計額
  owes: number;              // 負担すべき金額
  balance: number;           // 収支（paid - owes）
}
```

### Settlement（精算）

送金情報を保持します（計算結果）。

```typescript
{
  from: {                    // 送金元
    userId: string;
    displayName: string;
  };
  to: {                      // 送金先
    userId: string;
    displayName: string;
  };
  amount: number;            // 送金額
  status: 'pending' | 'completed';  // ステータス
  paypayLink: string;        // PayPayリンク（将来の拡張用）
  linePayLink: string;       // LINE Payリンク（将来の拡張用）
}
```

---

## システム構成

### ファイル構造

```
tatekaezamurai-bot/
├── server/
│   ├── src/
│   │   ├── index.ts                    # サーバーのエントリーポイント
│   │   ├── handlers/
│   │   │   └── commandHandler.ts       # コマンド処理ロジック
│   │   ├── services/
│   │   │   └── storageService.ts       # データの保存/読み込み
│   │   ├── utils/
│   │   │   ├── calculator.ts           # 計算ロジック
│   │   │   ├── formatter.ts            # メッセージフォーマット
│   │   │   └── parser.ts               # コマンドパース
│   │   └── types/
│   │       └── index.ts                # 型定義
│   ├── dist/                           # ビルド後のJavaScript
│   ├── data/                           # JSONデータ保存先
│   │   └── sessions/
│   │       └── {groupId}.json
│   ├── package.json
│   ├── tsconfig.json
│   └── .env                            # 環境変数
│
├── 現在の仕様_v260119.md               # このファイル
├── 運用手順書_v260119.md               # デプロイ手順
├── 修正履歴_v260118.md                 # 修正履歴
├── Raspberry Pi初期設定手順.md         # ラズパイ初期設定
└── Raspberry Piデプロイ手順.md         # ラズパイデプロイ
```

### 主要ファイルの役割

#### `index.ts`
- Expressサーバーの起動
- LINE Webhook エンドポイント（`/webhook`）の設定
- 署名検証
- イベントのルーティング

#### `commandHandler.ts`
- すべてのコマンド処理
- メッセージの振り分け
- LINE APIへの返信

**主要メソッド:**
- `handleMessage()` - メッセージイベントの処理
- `handleStart()` - 開始コマンド
- `handleJoinMember()` - 参加コマンド
- `handlePayment()` - 支払い記録
- `handleSettle()` - 清算コマンド
- `handleStatus()` - 状況確認コマンド
- `handleCancel()` - キャンセルコマンド
- `handleEnd()` - 終了コマンド
- `handleHelp()` - ヘルプコマンド
- `handleJoin()` - グループ参加時のウェルカムメッセージ

#### `storageService.ts`
- セッションデータの永続化
- JSONファイルへの読み書き
- 自動バックアップ機能

**主要メソッド:**
- `getSession()` - セッション取得
- `createSession()` - セッション作成
- `updateSession()` - セッション更新
- `endSession()` - セッション終了
- `addPayment()` - 支払い追加

#### `calculator.ts`
- 収支計算ロジック
- 送金パターン計算（貪欲法）

**主要メソッド:**
- `calculateBalances()` - 各メンバーの収支を計算
- `calculateSettlements()` - 最適な送金パターンを計算

#### `formatter.ts`
- メッセージのフォーマット
- 見やすい表示形式

**主要メソッド:**
- `formatSettlementMessage()` - 精算結果メッセージ
- `formatStatusMessage()` - 状況確認メッセージ
- `formatHelpMessage()` - ヘルプメッセージ

#### `parser.ts`
- コマンドの解析
- パターンマッチング

**主要メソッド:**
- `isStartCommand()` - 開始コマンドの判定
- `isJoinMemberCommand()` - 参加コマンドの判定
- `parsePaymentCommand()` - 支払い記録の解析
- `isSettleCommand()` - 清算コマンドの判定
- （その他各コマンドの判定メソッド）

### データの永続化

**保存場所:** `server/data/sessions/{groupId}.json`

**保存タイミング:**
- セッション作成時
- 参加者追加時
- 支払い記録時
- セッション更新時
- セッション終了時

**バックアップ:**
- 更新時に自動的にバックアップファイルを作成
- 形式: `{groupId}.json.backup`

---

## 制限事項

### 現在の制限

1. **グループ専用**
   - 1対1のトークでは動作しません
   - グループチャットでのみ使用可能

2. **途中参加の計算**
   - 途中で参加した人も、過去の支払いを含めて全て負担します
   - `participationRange`は記録されますが、計算には使用されていません

3. **送金記録機能なし**
   - 「誰が誰にいくら送金した」という記録機能はありません
   - 精算結果を表示するのみ

4. **複数セッション非対応**
   - 1つのグループで同時に複数のセッションを持つことはできません
   - 新しいセッションを開始する前に、現在のセッションを終了する必要があります

5. **オフライン動作不可**
   - Raspberry Piがオフラインだと動作しません
   - ngrokのトンネルが切れると動作しません

6. **ngrok無料版の制限**
   - URLが起動ごとに変わります
   - LINE DevelopersのWebhook URLを毎回更新する必要があります

### 今後の改善候補

- [ ] 途中参加・途中退出の計算に対応
- [ ] 送金完了の記録機能
- [ ] リマインダー機能
- [ ] PayPay / LINE Pay との連携
- [ ] グループメンバーの自動取得
- [ ] 複数セッションの同時管理
- [ ] データベース化（SQLite / PostgreSQL）
- [ ] Web UIの追加

---

## エラーメッセージ一覧

| 状況 | メッセージ |
|------|----------|
| グループ外での使用 | ⚠️ グループ専用です |
| セッション未開始 | ⚠️ まず「開始」してください |
| 未参加者の支払い記録 | ⚠️ まず「参加」してください |
| 既に参加済み | ⚠️ ○○さんは参加済みです |
| 支払い記録なし | ⚠️ 支払い記録がありません |
| キャンセルする記録なし | ⚠️ キャンセルする記録がありません |
| セッションがない | ⚠️ セッションがありません |
| 既に開始済み | ⚠️ 既に開始済みです<br><br>「状況」で確認 / 「終了」で再開始 |
| エラー発生 | ⚠️ エラーが発生しました |

---

## 環境変数

`.env` ファイルに以下の環境変数を設定する必要があります。

```env
# LINE Messaging API
LINE_CHANNEL_SECRET=your_channel_secret_here
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here

# Server
PORT=3000
```

**取得方法:**
1. LINE Developers コンソール (https://developers.line.biz/console/) にアクセス
2. プロバイダーとチャンネルを作成
3. Messaging API タブから取得

---

## API エンドポイント

### `POST /webhook`
LINE Platformからのイベントを受信するエンドポイント

**リクエスト:**
- ヘッダー: `x-line-signature`（署名検証用）
- ボディ: LINE Webhook イベント

**レスポンス:**
- `200 OK` - 成功
- `401 Unauthorized` - 署名検証失敗
- `400 Bad Request` - リクエスト不正

### `GET /health`
ヘルスチェック用エンドポイント

**レスポンス:**
```json
{
  "status": "OK",
  "timestamp": "2026-01-19T12:34:56.789Z"
}
```

### `GET /`
ルートエンドポイント

**レスポンス:**
```
清算くんLINEボット サーバー稼働中
```

---

## 開発者向け情報

### ビルド

```bash
cd server
npm install
npm run build
```

### ローカル起動

```bash
cd server
npm start
```

### デバッグモード

```bash
cd server
npm run dev
```

### 環境

- **Node.js**: v18以上推奨
- **TypeScript**: 5.x
- **LINE SDK**: @line/bot-sdk v9

---

## 更新履歴

### v2026.01.19（最新）
- ✅ 計算ロジックを人間の方法に変更（合計を先に計算してから割る）
- ✅ 誤差完全ゼロを実現
- ✅ メッセージをさらに簡潔に（参加、終了）
- ✅ 仕様書・手順書を整備

### v2026.01.18
- ✅ UI/UXを大幅改善（全メッセージを50-70%削減）
- ✅ 「参加」コマンド追加
- ✅ ヘルプトリガーを「?」から「ヘルプ」に変更
- ✅ 金額パースの致命的なバグ修正
- ✅ 参加者カウントの修正

詳細は `修正履歴_v260118.md` を参照してください。

---

**作成日:** 2026年1月19日
**バージョン:** v2026.01.19
**作成者:** Claude Code
