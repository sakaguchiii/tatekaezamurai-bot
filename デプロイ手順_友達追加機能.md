# 🚀 デプロイ手順 - 友達追加機能

**実装日**: 2026年1月25日
**機能**: 友達追加イベントの自動記録とウェルカムメッセージの改善

---

## ✅ 実装完了した機能

### 1. 友達情報の自動記録
- followイベント → 自動でデータベースに保存
- unfollowイベント → ブロック記録

### 2. 改善されたウェルカムメッセージ
- 3つのメッセージに分けて詳しく説明
- 使い方を5ステップで案内
- ポイントと統計機能の案内

### 3. friendService
- 友達一覧取得
- 友達数統計
- 月次統計

---

## 🚀 Raspberry Piでのデプロイ手順

### Step 1: 最新コードを取得

```bash
ssh sk283@raspberrypi.local
cd ~/tatekaezamurai-bot
git pull origin main
```

**期待される出力**:
```
remote: Enumerating objects: X, done.
...
 5 files changed, 316 insertions(+), 4 deletions(-)
 create mode 100644 server/src/migrations/002_add_friends_table.sql
 create mode 100644 server/src/services/friendService.ts
```

### Step 2: ビルド

```bash
cd server
npm run build
```

**期待される出力**:
```
> tatekaezamurai-server@1.0.0 build
> tsc && npm run copy-sql

> tatekaezamurai-server@1.0.0 copy-sql
> mkdir -p dist/migrations && cp src/migrations/*.sql dist/migrations/
```

### Step 3: サーバー再起動

```bash
pm2 restart all
```

**期待される出力**:
```
[PM2] Applying action restartProcessId on app [all](ids: [ 0 ])
[PM2] [tatekaezamurai](0) ✓
```

### Step 4: ログで確認

```bash
pm2 logs --lines 50
```

**確認ポイント**:
```
✅ マイグレーション実行: 001_initial_schema.sql
✅ マイグレーション実行: 002_add_friends_table.sql  ← 新しいテーブル作成
✅ データベーススキーマを初期化しました
```

---

## 🧪 テスト方法

### テスト1: 友達追加（新規ユーザー）

1. **テスト用のLINEアカウントで友達追加**
   - QRコードまたは検索で追加

2. **期待される動作**:
   - 3つのメッセージが届く
   - 1つ目: 挨拶とBot説明
   - 2つ目: 使い方（5ステップ）
   - 3つ目: ポイントとヘルプ案内

3. **ログで確認**:
   ```bash
   pm2 logs --lines 20 | grep "友達追加"
   ```

   **期待される出力**:
   ```
   👤 友達追加: テストユーザー (UxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxX)
   💾 友達を保存: テストユーザー (UxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxX)
   ```

### テスト2: データベース確認

```bash
cd ~/tatekaezamurai-bot/server

sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode table

-- 友達一覧
SELECT
  display_name,
  followed_at,
  is_active
FROM friends
ORDER BY followed_at DESC
LIMIT 5;
EOF
```

**期待される出力**:
```
+------------------+---------------------------+-----------+
| display_name     | followed_at               | is_active |
+------------------+---------------------------+-----------+
| テストユーザー   | 2026-01-25T12:00:00.000Z  | 1         |
| 阪口翼           | 2026-01-25T11:00:00.000Z  | 1         |
+------------------+---------------------------+-----------+
```

### テスト3: 友達数統計

```bash
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode line

-- 友達数
SELECT
  COUNT(*) as total_friends,
  SUM(CASE WHEN is_active = 1 THEN 1 ELSE 0 END) as active_friends,
  SUM(CASE WHEN is_active = 0 THEN 1 ELSE 0 END) as blocked_friends
FROM friends;

-- 今月の新規友達
SELECT COUNT(*) as new_friends_this_month
FROM friends
WHERE followed_at >= date('now', 'start of month');
EOF
```

**期待される出力**:
```
total_friends = 5
active_friends = 4
blocked_friends = 1

new_friends_this_month = 3
```

### テスト4: ブロックのテスト

1. **テスト用アカウントでBotをブロック**

2. **ログで確認**:
   ```bash
   pm2 logs --lines 20 | grep "ブロック"
   ```

   **期待される出力**:
   ```
   👋 ブロック/友達解除: UxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxX
   💾 友達をアンフォロー: UxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxX
   ```

3. **データベースで確認**:
   ```bash
   sqlite3 dist/data/database.db << 'EOF'
   SELECT display_name, is_active, unfollowed_at
   FROM friends
   WHERE user_id = 'UxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxX';
   EOF
   ```

   **期待される出力**:
   ```
   テストユーザー|0|2026-01-25T12:10:00.000Z
   ```

---

## 📊 データベース構造

### friendsテーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| user_id | TEXT (PK) | LINEユーザーID |
| display_name | TEXT | 表示名 |
| picture_url | TEXT | プロフィール画像URL |
| status_message | TEXT | ステータスメッセージ |
| followed_at | TEXT | 友達追加日時 |
| unfollowed_at | TEXT | ブロック日時 |
| is_active | INTEGER | アクティブフラグ（1=有効、0=ブロック） |
| created_at | TEXT | レコード作成日時 |
| updated_at | TEXT | レコード更新日時 |

### 使用例クエリ

```sql
-- アクティブな友達一覧
SELECT * FROM friends WHERE is_active = 1 ORDER BY followed_at DESC;

-- 友達数
SELECT COUNT(*) FROM friends WHERE is_active = 1;

-- 今月の友達追加数
SELECT COUNT(*) FROM friends WHERE followed_at >= date('now', 'start of month');

-- ブロック率
SELECT
  COUNT(*) as total,
  SUM(CASE WHEN is_active = 1 THEN 1 ELSE 0 END) as active,
  SUM(CASE WHEN is_active = 0 THEN 1 ELSE 0 END) as blocked,
  ROUND(100.0 * SUM(CASE WHEN is_active = 0 THEN 1 ELSE 0 END) / COUNT(*), 1) as block_rate
FROM friends;
```

---

## 🐛 トラブルシューティング

### 問題1: マイグレーションが実行されない

**症状**: ログに `✅ マイグレーション実行: 002_add_friends_table.sql` が表示されない

**原因**: SQLファイルがdist/にコピーされていない

**対処**:
```bash
cd ~/tatekaezamurai-bot/server
npm run build
pm2 restart all
```

### 問題2: 友達追加時にエラー

**症状**: ログに `❌ 友達追加処理エラー` が表示される

**確認**:
```bash
pm2 logs --lines 100 | grep "友達追加"
```

**考えられる原因**:
1. LINE APIのアクセストークンが無効
2. friendsテーブルが作成されていない

**対処**:
```bash
# テーブルが存在するか確認
sqlite3 dist/data/database.db "SELECT name FROM sqlite_master WHERE type='table' AND name='friends';"

# 空の場合、マイグレーションを手動実行
sqlite3 dist/data/database.db < dist/migrations/002_add_friends_table.sql
pm2 restart all
```

### 問題3: ウェルカムメッセージが送信されない

**症状**: 友達追加しても何もメッセージが来ない

**確認**:
1. pm2が起動しているか確認
   ```bash
   pm2 status
   ```

2. Webhookが正しく設定されているか確認
   ```bash
   curl http://localhost:3000/health
   ```

3. ログでfollowイベントを受信しているか確認
   ```bash
   pm2 logs --lines 100 | grep "follow"
   ```

---

## ✅ デプロイチェックリスト

```
□ git pull origin main でコードを取得
□ npm run build でビルド成功
□ pm2 restart all でサーバー再起動
□ pm2 logs でマイグレーション実行を確認
  ✅ マイグレーション実行: 002_add_friends_table.sql
□ 新規友達追加でテスト
  → 3つのメッセージが届く
□ ログで確認
  👤 友達追加: {名前}
  💾 友達を保存: {名前}
□ データベースで確認
  SELECT * FROM friends;
□ 統計を確認
  SELECT COUNT(*) FROM friends WHERE is_active = 1;
```

---

## 📈 期待される効果

### ユーザー体験の向上
- ✅ 友達追加時に詳しい使い方が分かる
- ✅ 個別チャットでも機能があることを知らせる

### 運営・分析の改善
- ✅ 友達数の推移を追跡できる
- ✅ ブロック率を分析できる
- ✅ 月次の成長率を確認できる

### 今後の機能拡張
- リマインダー送信（使っていない友達へ）
- 統計レポートの自動生成
- 個別チャット機能の追加

---

**デプロイが完了したら、友達追加をテストして動作を確認してください！** 🎉
