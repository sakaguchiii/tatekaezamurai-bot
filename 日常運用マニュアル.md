# 📅 日常運用マニュアル

**対象者**: 清算くんの運用担当者
**目的**: 定期的にやるべきことを忘れないため

---

## 📋 運用タスク一覧

| 頻度 | タスク | 所要時間 | 重要度 |
|------|--------|----------|--------|
| 毎日 | サーバー状態確認 | 1分 | ⭐⭐⭐ |
| 毎週 | ログチェック | 5分 | ⭐⭐ |
| 毎月 | バックアップ確認 | 5分 | ⭐⭐⭐ |
| 毎月 | ディスク容量確認 | 2分 | ⭐⭐ |
| 3ヶ月ごと | システムアップデート | 10分 | ⭐⭐ |
| 必要時 | コードのデプロイ | 10分 | ⭐⭐⭐ |

---

## 📆 毎日やること（所要時間: 1分）

### サーバー状態確認

**目的**: サーバーが正常に動作しているか確認

```bash
# Raspberry Piに接続
ssh sk283@raspberrypi.local

# サーバー状態確認
pm2 status
```

#### ✅ 正常な状態
```
┌─────┬──────────────┬─────────┬─────────┬─────────┐
│ id  │ name         │ status  │ restart │ uptime  │
├─────┼──────────────┼─────────┼─────────┼─────────┤
│ 0   │ tatekaezamurai│ online  │ 0       │ 5D      │
└─────┴──────────────┴─────────┴─────────┴─────────┘
```

- `status`: **online** ✅
- `restart`: 少ない方が良い（0〜2が理想）
- `uptime`: 長い方が安定している

#### ❌ 異常な状態
```
│ 0   │ tatekaezamurai│ errored │ 15      │ 0       │
```

- `status`: **errored** ❌
- `restart`: 頻繁に再起動している（10以上は要調査）

**対応方法**:
```bash
# エラー内容を確認
pm2 logs --err --lines 50

# 再起動を試す
pm2 restart all

# それでも直らない場合は「トラブルシューティングガイド」を参照
```

---

## 📅 毎週やること（所要時間: 5分）

### 1. ログチェック

**目的**: エラーや異常な動作を早期発見

```bash
# 最新100行のログを確認
pm2 logs --lines 100

# エラーだけ確認
pm2 logs --err --lines 50
```

#### チェックポイント

✅ **正常なログの例**:
```
📨 イベントを受信
✅ セッション作成
💰 支払い追加
💾 1件のセッションを一括保存しました
```

❌ **注意すべきログの例**:
```
❌ スキーマ初期化エラー
Error: ENOENT: no such file or directory
TypeError: Cannot read property 'xxx'
UnhandledPromiseRejectionWarning
```

**エラーが見つかったら**:
1. エラーメッセージをコピー
2. 「トラブルシューティングガイド」で検索
3. 解決しない場合はGitHubにIssue作成

### 2. 再起動回数の確認

```bash
pm2 status
```

`restart` の列をチェック：
- **0〜5回**: 正常
- **6〜10回**: 監視を強化
- **11回以上**: 原因調査が必要

**頻繁に再起動している場合**:
```bash
# メモリ使用状況を確認
free -h

# ディスク使用状況を確認
df -h

# プロセスのリソース使用状況
pm2 monit
```

---

## 📅 毎月やること（所要時間: 7分）

### 1. バックアップファイルの確認

**目的**: データが確実にバックアップされているか確認

```bash
# バックアップファイル一覧
ls -lh ~/tatekaezamurai-bot/server/dist/data/backups/

# 最新のバックアップを表示
ls -lt ~/tatekaezamurai-bot/server/dist/data/backups/ | head -5
```

#### チェックポイント

✅ **正常な状態**:
- 毎日のバックアップファイルが存在
- ファイルサイズが0でない（最低でも数KB）
- 過去7日分のファイルが残っている

```
-rw-r--r-- 1 sk283 sk283 17K 1月 22 03:00 sessions_2026-01-22.json
-rw-r--r-- 1 sk283 sk283 16K 1月 21 03:00 sessions_2026-01-21.json
-rw-r--r-- 1 sk283 sk283 18K 1月 20 03:00 sessions_2026-01-20.json
```

❌ **異常な状態**:
- バックアップファイルが存在しない
- ファイルサイズが0
- 数日間バックアップが作成されていない

**対応方法**:
```bash
# 手動でバックアップを作成
cd ~/tatekaezamurai-bot/server
npm run export-json

# 統計情報を確認
npm run export-json:stats
```

### 2. ディスク容量の確認

**目的**: ディスクが満杯になる前に対処

```bash
df -h
```

出力例:
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        29G  8.5G   19G  31% /
```

#### チェックポイント

- **Use% < 70%**: ✅ 正常
- **Use% 70〜85%**: ⚠️ 注意（不要ファイル削除を検討）
- **Use% > 85%**: ❌ 危険（すぐに対処）

**ディスク容量を確保する方法**:

```bash
# 1. 古いログファイルを削除
pm2 flush

# 2. aptキャッシュをクリア
sudo apt-get clean

# 3. 不要なパッケージを削除
sudo apt-get autoremove

# 4. 大きなファイルを探す
du -h ~ | sort -h | tail -20
```

### 3. データベースの健全性チェック

```bash
cd ~/tatekaezamurai-bot/server

# データベース統計を表示
npm run export-json:stats
```

出力例:
```
📊 データベース統計情報
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📈 セッション数（ステータス別）:
   active: 2件
   settled: 15件
   completed: 30件

💰 支払い統計:
   総支払い件数: 120件
   総支払い金額: 456,000円

👥 メンバー統計:
   総メンバー数: 235名
   平均メンバー数: 5.0名/セッション
```

#### 確認ポイント

- セッション数が増えているか
- 異常に多い `active` セッション（清算されていない）がないか
- 総支払い金額が妥当か

---

## 📅 3ヶ月ごとにやること（所要時間: 10分）

### システムアップデート

**目的**: セキュリティパッチとバグ修正を適用

```bash
# Raspberry Piのシステムアップデート
sudo apt-get update
sudo apt-get upgrade -y

# Node.jsのパッケージアップデート（慎重に）
cd ~/tatekaezamurai-bot/server
npm outdated  # アップデート可能なパッケージを確認

# マイナーバージョンのみアップデート（安全）
npm update

# ビルドとテスト
npm run build
npm test  # テストがある場合

# 問題なければ再起動
pm2 restart all
```

**注意**: メジャーバージョンアップは慎重に行う
- `better-sqlite3` のアップデートは特に注意（再コンパイルが必要）
- アップデート前に必ずバックアップを取る

---

## 📅 必要に応じてやること

### コードのデプロイ（新機能追加時）

**所要時間**: 10分

#### 手順

```bash
# 1. サーバーを停止
pm2 stop all

# 2. 最新コードを取得
cd ~/tatekaezamurai-bot
git pull origin main

# 3. 依存関係のインストール（package.jsonが変更された場合）
cd server
npm install

# 4. ビルド
npm run build

# 5. サーバー起動
pm2 restart all

# 6. ログで確認
pm2 logs --lines 50
```

#### 確認ポイント

✅ **成功した場合**:
```
✅ 環境変数を確認しました
🗄️ SQLiteデータベース接続完了
✅ データベーススキーマを初期化しました
💾 キャッシュサービスを初期化しました
🚀 サーバーが起動しました ポート: 3000
⏰ 自動バックアップを開始します
```

❌ **失敗した場合**:
```
❌ スキーマ初期化エラー
Error: Cannot find module 'xxx'
```
→ 「トラブルシューティングガイド」を参照

#### ロールバック（元に戻す）

デプロイ後に問題が発生した場合:

```bash
# 1. 前のバージョンに戻す
git log --oneline -10  # コミット履歴を確認
git checkout <前のコミットハッシュ>

# 2. 再ビルド
npm run build

# 3. 再起動
pm2 restart all
```

---

## 📊 監視ダッシュボード（推奨）

### pm2 monit（リアルタイムモニタリング）

```bash
pm2 monit
```

表示内容:
- CPU使用率
- メモリ使用量
- リアルタイムログ

**終了**: `Ctrl + C`

### pm2 web（ブラウザでモニタリング）

```bash
pm2 web
```

ブラウザで `http://raspberrypi.local:9615` にアクセス

---

## 🔔 アラート設定（上級者向け）

### pm2-logrotate（ログローテーション）

```bash
# インストール
pm2 install pm2-logrotate

# 設定
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

### Slackやメール通知

- pm2-slack: Slackに通知
- nodemailer: メール送信

（詳細は別途ドキュメント化）

---

## 📝 運用記録テンプレート

コピーして使ってください：

```
## 運用記録 - YYYY/MM/DD

### サーバー状態
- [ ] pm2 status: 正常
- [ ] 再起動回数: X回
- [ ] uptime: X日

### ログチェック
- [ ] エラーログ確認
- [ ] 異常なし / 異常あり（詳細: ______）

### バックアップ
- [ ] 最新バックアップ日時: YYYY/MM/DD HH:MM
- [ ] バックアップファイルサイズ: XX KB

### ディスク容量
- [ ] 使用率: XX%
- [ ] 残り容量: XX GB

### 所感・備考
- （気づいたことを記録）
```

---

## ✅ 月次チェックリスト（印刷用）

```
□ サーバー状態確認（毎日）
□ ログチェック（毎週）
□ バックアップファイル確認
□ ディスク容量確認
□ データベース統計確認
□ セキュリティアップデート（3ヶ月ごと）
□ 運用記録の作成
```

---

## 🎯 運用のコツ

### 1. 定期的にチェックする習慣をつける
- 毎朝同じ時間にチェック
- カレンダーにリマインダー設定

### 2. 小さな異常を見逃さない
- 再起動回数が増えてきた
- ログに警告が出ている
→ 早めに対処すれば大きなトラブルを防げる

### 3. バックアップは複数の場所に
- Raspberry Pi内のバックアップ
- 外部ストレージ（USBメモリなど）
- クラウドストレージ（Google Drive、Dropboxなど）

### 4. ドキュメントを更新する
- 新しい問題が起きたら、解決方法を記録
- 次の担当者のために残す

---

## 📞 エスカレーション（困ったら）

問題が解決しない場合:

1. **トラブルシューティングガイド.md** を確認
2. **GitHubのIssue** を検索
3. **新しいIssue** を作成
   - エラーメッセージをコピー
   - `pm2 logs --lines 200` の出力を添付
   - 何をしたか、何が起きたかを記載

---

**運用は継続が大事！小さなチェックを積み重ねることで、大きなトラブルを防げます。** 🎯
