# 🔧 トラブルシューティングガイド

**対象者**: 清算くんでトラブルが発生した人
**使い方**: エラーメッセージや症状で検索（`Ctrl+F` または `⌘+F`）

---

## 📋 目次

1. [サーバー起動関連](#サーバー起動関連)
2. [データベース関連](#データベース関連)
3. [LINE連携関連](#line連携関連)
4. [パフォーマンス関連](#パフォーマンス関連)
5. [ネットワーク関連](#ネットワーク関連)
6. [ビルド・デプロイ関連](#ビルドデプロイ関連)
7. [データ関連](#データ関連)

---

## サーバー起動関連

### ❌ サーバーが起動しない（status: errored）

**症状**:
```bash
pm2 status
# → status: errored
```

**診断手順**:

```bash
# 1. エラーログを確認
pm2 logs --err --lines 100

# 2. 以下のエラーメッセージを探す
```

#### ケース1: ポートがすでに使用されている

**エラーメッセージ**:
```
Error: listen EADDRINUSE: address already in use :::3000
```

**原因**: ポート3000が別のプロセスで使われている

**解決方法**:
```bash
# ポート3000を使っているプロセスを探す
sudo lsof -i :3000

# 出力例:
# COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
# node    12345  sk283   22u  IPv6 123456      0t0  TCP *:3000 (LISTEN)

# プロセスを終了
kill -9 12345

# pm2を再起動
pm2 restart all
```

#### ケース2: 環境変数ファイルがない

**エラーメッセージ**:
```
❌ 必要な環境変数が設定されていません
CHANNEL_SECRET または CHANNEL_ACCESS_TOKEN が設定されていません
```

**原因**: `.env` ファイルが存在しないか、内容が不正

**解決方法**:
```bash
# .envファイルの存在確認
ls -la ~/tatekaezamurai-bot/server/.env

# ない場合は作成
cd ~/tatekaezamurai-bot/server
nano .env

# 以下を記入（実際の値に置き換える）:
CHANNEL_SECRET=your_channel_secret_here
CHANNEL_ACCESS_TOKEN=your_channel_access_token_here

# 保存: Ctrl+O → Enter → Ctrl+X

# 再起動
pm2 restart all
```

#### ケース3: Node.jsのバージョンが古い

**エラーメッセージ**:
```
SyntaxError: Unexpected token '?'
```

**原因**: Node.jsのバージョンが古い（v18未満）

**解決方法**:
```bash
# 現在のバージョン確認
node -v

# v18未満の場合、アップデート
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 確認
node -v
# → v18.20.8 または それ以上

# 再ビルドと再起動
cd ~/tatekaezamurai-bot/server
npm run build
pm2 restart all
```

---

## データベース関連

### ❌ スキーマ初期化エラー

**エラーメッセージ**:
```
❌ スキーマ初期化エラー: Error: ENOENT: no such file or directory, open '/home/sk283/tatekaezamurai-bot/server/dist/migrations/001_initial_schema.sql'
```

**原因**: ビルド時にSQLファイルがコピーされていない

**解決方法**:
```bash
cd ~/tatekaezamurai-bot/server

# 再ビルド（SQLファイルがコピーされる）
npm run build

# ファイルが存在するか確認
ls -l dist/migrations/001_initial_schema.sql

# 再起動
pm2 restart all
```

### ❌ データベースがロックされている

**エラーメッセージ**:
```
SqliteError: database is locked
```

**原因**: 複数のプロセスが同時にデータベースにアクセスしようとしている

**解決方法**:
```bash
# 1. すべてのプロセスを停止
pm2 stop all

# 2. WALファイルをチェックポイント
cd ~/tatekaezamurai-bot/server
sqlite3 dist/data/database.db "PRAGMA wal_checkpoint(TRUNCATE);"

# 3. 再起動
pm2 start all
```

### ❌ データベースが壊れている

**エラーメッセージ**:
```
SqliteError: database disk image is malformed
```

**原因**: データベースファイルが破損している（停電、強制終了など）

**解決方法**:

```bash
# 1. サーバー停止
pm2 stop all

# 2. バックアップから復元
cd ~/tatekaezamurai-bot/server

# 最新のバックアップを確認
ls -lt dist/data/backups/ | head -5

# データベースを削除
mv dist/data/database.db dist/data/database.db.broken

# バックアップをsrc/data/にコピー
cp dist/data/backups/sessions_2026-01-22.json src/data/sessions.json

# 3. サーバー起動（自動的に再作成される）
pm2 start all

# 4. ログで確認
pm2 logs --lines 50
# 「📦 JSONからSQLiteへの移行を開始」が表示されればOK
```

### ❌ better-sqlite3 のインストールエラー

**エラーメッセージ**:
```
gyp ERR! build error
npm ERR! Failed at the better-sqlite3@12.6.2 install script
```

**原因**: ビルドツールがインストールされていない

**解決方法**:
```bash
# ビルドツールをインストール
sudo apt-get update
sudo apt-get install -y build-essential python3

# better-sqlite3を再ビルド
cd ~/tatekaezamurai-bot/server
npm rebuild better-sqlite3

# 全体を再インストール
npm install

# ビルド
npm run build

# 再起動
pm2 restart all
```

---

## LINE連携関連

### ❌ LINEで送信しても反応がない

**診断フローチャート**:

```
1. サーバーは動いている？
   ├─ No → pm2 start all
   └─ Yes → 2へ

2. ログに「📨 イベントを受信」が出る？
   ├─ Yes → 3へ
   └─ No → 4へ

3. エラーログが出ている？
   ├─ Yes → エラー内容を確認
   └─ No → LINEのAPI制限を確認

4. Webhookが届いていない
   → ngrok確認 or Webhook URL確認
```

#### ケース1: Webhookが届いていない

**確認方法**:
```bash
# リアルタイムでログを監視
pm2 logs

# LINEでメッセージを送信
# → 「📨 イベントを受信」が出るか？
```

**出ない場合の原因**:
1. ngrokが停止している
2. Webhook URLが間違っている
3. ngrokのURLが変わった

**解決方法**:

```bash
# ngrokが動いているか確認（別ターミナル）
ps aux | grep ngrok

# 動いていない場合、起動
ngrok http 3000

# 表示されるURL（例: https://abc123.ngrok.io）をコピー

# LINE Developersで設定
# 1. https://developers.line.biz/console/ にアクセス
# 2. あなたのチャネルを選択
# 3. Messaging API設定 → Webhook URL
# 4. https://abc123.ngrok.io/webhook を入力
# 5. 「検証」をクリック → 成功すればOK
```

#### ケース2: LINE APIのエラー

**エラーメッセージ**:
```
LINE API Error: 401 Unauthorized
```

**原因**: Channel Access Tokenが間違っているか期限切れ

**解決方法**:
```bash
# 1. LINE Developersでトークンを確認
# https://developers.line.biz/console/

# 2. .envファイルを更新
cd ~/tatekaezamurai-bot/server
nano .env

# CHANNEL_ACCESS_TOKEN を正しい値に更新

# 3. 再起動
pm2 restart all
```

#### ケース3: レスポンスタイムアウト

**エラーメッセージ**:
```
Timeout: LINE response took longer than 30 seconds
```

**原因**: 処理が遅すぎる（データベースの問題など）

**解決方法**:
```bash
# 1. パフォーマンステスト
cd ~/tatekaezamurai-bot/server
npm run test:performance

# 2. データベースの最適化
cd ~/tatekaezamurai-bot/server
sqlite3 dist/data/database.db "VACUUM;"

# 3. キャッシュをクリア
pm2 restart all
```

---

## パフォーマンス関連

### ⚠️ サーバーの応答が遅い

**診断**:

```bash
# CPU使用率とメモリを確認
pm2 monit

# システム全体のリソース
htop
# （Raspberry Piに入っていない場合: sudo apt-get install htop）
```

#### ケース1: メモリ不足

**症状**:
```bash
free -h
              total        used        free      shared  buff/cache   available
Mem:           3.7G        3.5G        100M         50M        100M        50M
```
→ `available` が 100MB 以下

**解決方法**:
```bash
# 1. 不要なプロセスを停止
ps aux --sort=-%mem | head -10

# 2. Raspberry Piを再起動
sudo reboot

# 3. スワップメモリを増やす（上級者向け）
sudo dphys-swapfile swapoff
sudo nano /etc/dphys-swapfile
# CONF_SWAPSIZE=1024 に変更
sudo dphys-swapfile setup
sudo dphys-swapfile swapon
```

#### ケース2: ディスク容量不足

**症状**:
```bash
df -h
/dev/root        29G   28G   1.0G  97% /
```
→ 使用率が 90% 以上

**解決方法**:
```bash
# 1. 不要なファイルを探す
du -h ~ | sort -h | tail -20

# 2. ログファイルを削除
pm2 flush

# 3. aptキャッシュクリア
sudo apt-get clean
sudo apt-get autoremove

# 4. 古いバックアップを手動削除
cd ~/tatekaezamurai-bot/server/dist/data/backups
ls -lt
# 必要に応じて古いものを削除
rm sessions_2025-12-*.json
```

#### ケース3: データベースの肥大化

**症状**:
```bash
ls -lh ~/tatekaezamurai-bot/server/dist/data/database.db
# → 100MB 以上
```

**解決方法**:
```bash
# データベースを最適化
cd ~/tatekaezamurai-bot/server
pm2 stop all

sqlite3 dist/data/database.db "VACUUM;"
sqlite3 dist/data/database.db "PRAGMA wal_checkpoint(TRUNCATE);"

pm2 start all
```

---

## ネットワーク関連

### ❌ Raspberry Piに接続できない

**症状**:
```bash
ssh sk283@raspberrypi.local
# → ssh: Could not resolve hostname raspberrypi.local
```

**診断手順**:

```bash
# 1. Raspberry Piの電源は入っている？
# → LEDランプを確認

# 2. 同じネットワークに接続している？
# → Mac/PCのWi-Fi設定を確認

# 3. IPアドレスを調べる
# ルーターの管理画面（例: 192.168.1.1）で確認

# 4. IPアドレスで接続
ssh sk283@192.168.1.100  # 実際のIPアドレスに置き換え
```

### ❌ ngrokが接続できない

**エラーメッセージ**:
```
ERR_NGROK_108: Failed to connect to ngrok
```

**原因**: インターネット接続の問題 or ngrokのサービス障害

**解決方法**:
```bash
# 1. インターネット接続確認
ping google.com

# 2. ngrokのステータス確認
# https://status.ngrok.com/

# 3. ngrokを再起動
pkill ngrok
ngrok http 3000

# 4. 別のトンネリングサービスを使う（緊急時）
# - localtunnel: npx localtunnel --port 3000
# - serveo: ssh -R 80:localhost:3000 serveo.net
```

---

## ビルド・デプロイ関連

### ❌ npm run build でエラー

**エラーメッセージ**:
```
error TS2307: Cannot find module 'xxx'
```

**原因**: 依存関係がインストールされていない

**解決方法**:
```bash
cd ~/tatekaezamurai-bot/server

# node_modulesを削除して再インストール
rm -rf node_modules package-lock.json
npm install

# 再ビルド
npm run build
```

### ❌ git pull でコンフリクト

**エラーメッセージ**:
```
error: Your local changes to the following files would be overwritten by merge:
        server/package.json
```

**原因**: ローカルの変更とリモートの変更が競合

**解決方法**:

**方法1: ローカルの変更を破棄**（データファイル以外）
```bash
cd ~/tatekaezamurai-bot

# 変更を確認
git status

# 変更を破棄（注意！）
git reset --hard HEAD
git pull origin main
```

**方法2: ローカルの変更を保持**
```bash
# 変更を一時保存
git stash

# 最新コードを取得
git pull origin main

# 変更を復元
git stash pop

# コンフリクトがあれば手動で解決
```

---

## データ関連

### ❌ データが消えた

**落ち着いてください。バックアップがあります。**

**復元手順**:

```bash
# 1. バックアップファイルを確認
ls -lt ~/tatekaezamurai-bot/server/dist/data/backups/

# 2. 最新のバックアップをコピー
cd ~/tatekaezamurai-bot/server
cp dist/data/backups/sessions_2026-01-22.json src/data/sessions.json

# 3. データベースを削除（再作成させる）
rm dist/data/database.db

# 4. サーバー再起動
pm2 restart all

# 5. ログで確認
pm2 logs --lines 50
# 「📦 JSONからSQLiteへの移行を開始 (Xセッション)」が表示されればOK
```

### ❌ セッションが「active」のまま終わらない

**症状**: 古いセッションが `active` 状態で残っている

**手動で終了する方法**:

```bash
cd ~/tatekaezamurai-bot/server

# SQLiteで直接更新
sqlite3 dist/data/database.db

# SQLite プロンプト内で:
UPDATE sessions
SET status = 'completed',
    updated_at = datetime('now')
WHERE group_id = 'グループIDをここに入力';

# 終了
.exit

# サーバー再起動
pm2 restart all
```

**注意**: グループIDは `pm2 logs` から確認できます。

---

## 🚨 緊急時の対応

### サーバーが完全にクラッシュした場合

```bash
# 1. すべて停止
pm2 kill

# 2. 最小構成で起動
cd ~/tatekaezamurai-bot/server
node dist/index.js

# エラーが出る → ログを確認して原因特定
# エラーが出ない → pm2の問題
#   → pm2 start dist/index.js --name tatekaezamurai
```

### Raspberry Piが起動しない場合

1. **SDカードを取り出す**
2. **別のPCで読み込む**
3. **バックアップファイルを救出**:
   ```
   /home/sk283/tatekaezamurai-bot/server/dist/data/backups/
   ```
4. **SDカードを初期化して再セットアップ**
5. **バックアップを復元**

---

## 📞 それでも解決しない場合

### 情報収集

```bash
# 以下の情報を集める
node -v > debug_info.txt
npm -v >> debug_info.txt
pm2 --version >> debug_info.txt
pm2 status >> debug_info.txt
pm2 logs --lines 200 >> debug_info.txt
df -h >> debug_info.txt
free -h >> debug_info.txt
```

### GitHubにIssue作成

1. https://github.com/sakaguchiii/tatekaezamurai-bot/issues
2. 「New Issue」をクリック
3. タイトル: 簡潔にエラー内容
4. 本文:
   - 何をしたか
   - 何が起きたか
   - `debug_info.txt` の内容（秘密情報を削除）

---

## 🎯 トラブル予防のヒント

1. **定期的にバックアップを確認**
   ```bash
   ls -lt ~/tatekaezamurai-bot/server/dist/data/backups/
   ```

2. **変更前にバックアップを取る**
   ```bash
   npm run export-json
   ```

3. **ログを定期的にチェック**
   ```bash
   pm2 logs --lines 100 | grep -i error
   ```

4. **アップデートは慎重に**
   - いきなり本番環境で試さない
   - テスト環境があれば先にテスト

---

**トラブルは必ず解決できます！落ち着いて、手順通りに進めてください。** 🔧
