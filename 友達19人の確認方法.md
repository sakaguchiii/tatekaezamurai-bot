# 👥 友達19人の確認方法

**問題**: 友達追加している19人のうち、一度もBotを使っていない人が多いため、ログに記録がない

---

## 🎯 最も簡単で確実な方法

### LINE Official Account Manager で確認 ⭐⭐⭐⭐⭐

**推奨度**: 最高 - 公式管理画面で全友達情報を確認できます

#### 手順

1. **LINE Official Account Manager にアクセス**

   https://manager.line.biz/

2. **ログイン**

   LINE Botを作成したアカウントでログイン

3. **該当のアカウントを選択**

   「清算くん」または該当するBot名をクリック

4. **ホーム画面で確認**

   画面上部に「友だち数」が表示されます

   ```
   友だち数: 19
   ターゲットリーチ: XX
   ブロック数: XX
   ```

5. **詳細な分析（オプション）**

   左メニュー → **「分析」** → **「友だち」**

   ここで以下が確認できます：
   - 友だち数の推移（グラフ）
   - 友だち追加数（日別）
   - ブロック数の推移
   - ターゲットリーチ

---

## 📊 確認できる情報

### 1. 友だち総数

現在の友だち数（ブロック含む）

### 2. ターゲットリーチ

メッセージを送信できる有効な友だち数（ブロックを除く）

### 3. ブロック数

友だち追加後にブロックされた数

### 4. 友だち追加の推移

日別・週別・月別の友だち追加数とブロック数のグラフ

---

## 💡 個別の友達リストを取得する方法

LINE Messaging API では、**友達リスト（全員の名前とuserID）を直接取得する方法はありません**。

### 代替方法

#### 方法1: Broadcast送信時にエラーで確認（非推奨）

```typescript
// 全友達にメッセージを送信
await client.broadcast({
  messages: [{
    type: 'text',
    text: 'テスト'
  }]
});
```

**デメリット**:
- 実際にメッセージが送信される
- 個別のuserIdは取得できない
- 不要なメッセージで友達に迷惑

#### 方法2: 今後のためにfollowイベントを記録（推奨）

**実装案**: 友達追加時に自動でデータベースに保存

```typescript
// index.ts にハンドラー追加
else if (event.type === 'follow') {
  await commandHandler.handleFollow(event);
}

// commandHandler.ts
async handleFollow(event: line.WebhookEvent): Promise<void> {
  if (event.type !== 'follow') return;

  const userId = event.source.userId;
  const profile = await client.getProfile(userId);

  // データベースに保存
  await friendService.saveFriend({
    userId: profile.userId,
    displayName: profile.displayName,
    followedAt: new Date().toISOString(),
  });

  console.log(`👤 友達追加: ${profile.displayName}`);
}
```

**メリット**:
- 今後の友達は全て記録される
- いつでもリストを確認できる
- 統計情報が取れる

---

## 🔍 現状で分かること

### ログから分かる人

```bash
# Raspberry Piで実行
cd ~/tatekaezamurai-bot/server
npm run get-users-from-log ~/.pm2/logs/tatekaezamurai-out*.log
```

**結果**: Botを使ったことがある人のみ（4名など）

### セッションデータから分かる人

```bash
cd ~/tatekaezamurai-bot/server

sqlite3 dist/data/database.db << 'EOF'
SELECT DISTINCT
  json_extract(value, '$.displayName') as display_name,
  json_extract(value, '$.userId') as user_id
FROM sessions, json_each(json_extract(data, '$.members'))
ORDER BY display_name;
EOF
```

**結果**: セッションに参加した人のみ

### 差分

```
友だち総数: 19名
ログから検出: 4名
セッションから検出: 6名（推測）

不明: 13名 ← 友達追加したがBotを一度も使っていない
```

---

## 📈 分析例

### LINE Official Account Manager での確認結果

```
友だち数: 19名
ターゲットリーチ: 17名
ブロック数: 2名

→ アクティブな友だち: 17名
→ ブロック率: 10.5%
```

### 使用状況

```
Botを使ったことがある人: 4名（ログから）
友達追加のみで未使用: 15名

→ 使用率: 21% (4/19)
```

**インサイト**:
- 友達追加はしているが、使っていない人が多い
- 使い方の案内が必要かもしれない
- QRコード経由で追加したが、何のBotか忘れている可能性

---

## 💡 改善提案

### 1. ウェルカムメッセージの改善

友達追加時に使い方を詳しく説明：

```typescript
await client.replyMessage({
  replyToken: event.replyToken,
  messages: [{
    type: 'text',
    text:
`ようこそ！清算くんです🍻

【使い方】
1️⃣ 友達とのLINEグループに私を追加
2️⃣ グループで「開始」と送信
3️⃣ メンバーが「参加」と送信
4️⃣ 支払いを記録
   例：1軒目 5000
5️⃣ 最後に「精算」

詳しくは「ヘルプ」と送ってください。

※個別チャットでは統計機能のみ使えます`
  }]
});
```

### 2. リマインダー送信（定期）

使っていない友達に定期的にリマインダー：

```typescript
// 月1回、全友達に送信
await client.broadcast({
  messages: [{
    type: 'text',
    text: '清算くんです。飲み会の割り勘を簡単にします！グループに追加して「開始」と送信してください。'
  }]
});
```

**注意**: 頻繁すぎるとブロックされるため、月1回程度に抑える

### 3. リッチメニュー追加

ボタンで簡単に使い方を確認できるようにする

---

## 🎯 まとめ

### 友達リストの確認方法

| 方法 | できること | 難易度 |
|------|----------|--------|
| **LINE Official Account Manager** | 友だち総数、ブロック数、推移 | ⭐ 簡単 |
| ログ分析 | 使ったことがある人のみ | ⭐⭐ 中 |
| セッション分析 | 参加したことがある人のみ | ⭐⭐ 中 |
| Insight API | 統計情報のみ（個別リストは不可） | ⭐⭐⭐ 難 |
| followイベント記録 | 今後の友達は全て記録（過去は不可） | ⭐⭐⭐ 難 |

### 推奨アクション

1. **今すぐ**: LINE Official Account Manager で友だち数を確認
2. **短期**: ログとセッションデータから使用者リストを作成
3. **中期**: followイベントハンドラーを実装して今後の友達を記録
4. **長期**: 使用率を上げるための改善（ウェルカムメッセージ、リマインダー）

---

## 📝 確認手順（実践）

### Raspberry Piで実行

```bash
# 1. ログから使用者を確認
cd ~/tatekaezamurai-bot/server
cat ~/.pm2/logs/tatekaezamurai-out*.log > /tmp/all_logs.txt
npm run get-users-from-log /tmp/all_logs.txt

# 2. セッションから参加者を確認
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode table
SELECT DISTINCT
  json_extract(value, '$.displayName') as display_name
FROM sessions, json_each(json_extract(data, '$.members'))
ORDER BY display_name;
EOF

# 3. 結果を記録
# → X名が使用経験あり
```

### Webで確認

```
1. https://manager.line.biz/ にアクセス
2. ログイン
3. 友だち数を確認
   → 19名であることを確認

4. 分析 → 友だち で詳細を確認
   → 推移グラフ、ブロック数など
```

---

**結論**:
- 19人全員の個別リストを取得するのは不可能
- しかし、LINE Official Account Manager で総数とブロック数は確認可能
- 今後のために followイベント記録の実装を推奨
