# ğŸ” å‹é”è¿½åŠ 19äºº - ç‰¹å®šæ‰‹é †

**ç›®æ¨™**: ç¾åœ¨å‹é”è¿½åŠ ã—ã¦ã„ã‚‹19äººå…¨å“¡ã‚’ç‰¹å®šã™ã‚‹

---

## ğŸ“Š ç¾çŠ¶

- **ç¾åœ¨ã®ãƒ­ã‚°ã‹ã‚‰æ¤œå‡º**: 4å
- **å‹é”è¿½åŠ ç·æ•°**: 19å
- **ä¸è¶³**: 15åã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦

---

## ğŸ” æ–¹æ³•1: Raspberry Piã®å…¨ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆæ¨å¥¨ï¼‰â­â­â­â­â­

### Step 1: pm2ã®å…¨ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª

```bash
cd ~/tatekaezamurai-bot/server

# pm2ã®ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
ls -lh ~/.pm2/logs/

# å‡ºåŠ›ä¾‹:
# tatekaezamurai-out.log        â† ç¾åœ¨ã®ãƒ­ã‚°
# tatekaezamurai-out-0.log      â† ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸå¤ã„ãƒ­ã‚°
# tatekaezamurai-out-1.log
# tatekaezamurai-error.log
```

### Step 2: å…¨ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆ

```bash
# å…¨ãƒ­ã‚°ã‚’çµåˆã—ã¦ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
cat ~/.pm2/logs/tatekaezamurai-out*.log > /tmp/all_logs.txt

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
ls -lh /tmp/all_logs.txt

# è¡Œæ•°ç¢ºèª
wc -l /tmp/all_logs.txt
```

### Step 3: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—

```bash
npm run get-users-from-log /tmp/all_logs.txt
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:
```
ğŸ” ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æŠ½å‡ºä¸­...
âœ… 19ä»¶ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç™ºè¦‹

ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§:
1. é˜ªå£ç¿¼
2. ã•ã
3. åœ­ä¸€éƒ
...
19. (åå‰)

ğŸ“Š ã‚µãƒãƒªãƒ¼:
   ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: 19å
   å–å¾—æˆåŠŸ: XXå
   å–å¾—å¤±æ•—: XXå
```

---

## ğŸ” æ–¹æ³•2: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨æ¸¬

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ã€å‚åŠ ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèªï¼š

```bash
cd ~/tatekaezamurai-bot/server

sqlite3 dist/data/database.db << 'EOF'
.mode line

-- å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’æŠ½å‡º
SELECT DISTINCT
  json_extract(value, '$.userId') as user_id,
  json_extract(value, '$.displayName') as display_name
FROM sessions, json_each(json_extract(data, '$.members'))
ORDER BY display_name;
EOF
```

**å‡ºåŠ›ä¾‹**:
```
user_id = Ucdc6f609c888a5de55a124e70aa68d6d
display_name = é˜ªå£ç¿¼

user_id = Uca76d716e995f6377b955408bb56ce4f
display_name = ã•ã
```

ã“ã‚Œã§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ãŸäººã®åå‰ã¨userIdãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

---

## ğŸ” æ–¹æ³•3: LINE Messaging APIã§ç›´æ¥å–å¾—ï¼ˆé›£æ˜“åº¦é«˜ï¼‰

LINE Messaging APIã«ã¯ã€Œå‹é”ãƒªã‚¹ãƒˆå–å¾—ã€ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

**ä»£æ›¿æ¡ˆ**:
- Broadcast API ã®é€ä¿¡å¯¾è±¡æ•°ã‹ã‚‰æ¨æ¸¬
- å®Ÿéš›ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

**ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹** (`check-friends-count.ts`):

```typescript
import * as line from '@line/bot-sdk';
import * as dotenv from 'dotenv';

dotenv.config();

const client = new line.messagingApi.MessagingApiClient({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN || '',
});

async function checkFriendsCount() {
  try {
    // é€ä¿¡å¯èƒ½ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°ã‚’å–å¾—
    const quota = await client.getMessageQuota();
    console.log('ğŸ“Š ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¯èƒ½æ•°:', quota);

    // å‹é”æ•°ã®å–å¾—ï¼ˆBroadcast APIã‚’ä½¿ç”¨ï¼‰
    // æ³¨æ„: ã“ã‚Œã¯æ¦‚ç®—å€¤ã§ã™
    const insight = await client.getNumberOfFollowers({
      date: new Date().toISOString().slice(0, 10).replace(/-/g, '')
    });
    console.log('ğŸ‘¥ å‹é”æ•°ï¼ˆæ¦‚ç®—ï¼‰:', insight);
  } catch (error: any) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);
  }
}

checkFriendsCount();
```

**æ³¨æ„**: ã“ã®æ–¹æ³•ã¯æ­£ç¢ºãªãƒªã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚

---

## ğŸ¯ æ¨å¥¨æ‰‹é †ï¼ˆã¾ã¨ã‚ï¼‰

### Raspberry Piã§å®Ÿè¡Œ

```bash
# 1. ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
ssh sk283@raspberrypi.local

# 2. æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
cd ~/tatekaezamurai-bot
git pull origin main

# 3. ãƒ“ãƒ«ãƒ‰
cd server
npm run build

# 4. å…¨ãƒ­ã‚°ã‚’çµåˆ
cat ~/.pm2/logs/tatekaezamurai-out*.log > /tmp/all_logs.txt

# 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
npm run get-users-from-log /tmp/all_logs.txt

# 6. JSONå½¢å¼ã§ã‚‚ä¿å­˜
npm run get-users-from-log /tmp/all_logs.txt -- --json

# 7. JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ”ãƒ¼ï¼ˆMacå´ã§å®Ÿè¡Œï¼‰
scp sk283@raspberrypi.local:~/tatekaezamurai-bot/server/users_from_log.json .
```

---

## ğŸ“Š è¿½åŠ ã®ç¢ºèªæ–¹æ³•

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚‚ç¢ºèª

```bash
cd ~/tatekaezamurai-bot/server

sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode table

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
SELECT COUNT(DISTINCT json_extract(value, '$.userId')) as unique_users
FROM sessions, json_each(json_extract(data, '$.members'));

-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆ
SELECT DISTINCT
  json_extract(value, '$.displayName') as display_name
FROM sessions, json_each(json_extract(data, '$.members'))
ORDER BY display_name;
EOF
```

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ãƒ­ã‚°ãŒå°‘ãªã„

**åŸå› **: pm2ãŒãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ãªã„ã€ã¾ãŸã¯å¤ã„ãƒ­ã‚°ãŒå‰Šé™¤ã•ã‚ŒãŸ

**å¯¾å‡¦**:
```bash
# pm2ã®ãƒ­ã‚°è¨­å®šã‚’ç¢ºèª
pm2 show tatekaezamurai

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
pm2 install pm2-logrotate
```

### å•é¡Œ2: 19äººã«å±Šã‹ãªã„

**åŸå› **:
1. ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿
2. ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹å‰ã«å‹é”è§£é™¤ã—ãŸ
3. åˆ¥ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®å‹é”è¿½åŠ ï¼ˆQRã‚³ãƒ¼ãƒ‰ãªã©ï¼‰ã§ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„

**å¯¾å‡¦**:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚°ã‚’ä¸¡æ–¹ç¢ºèª
- ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã‚«ã‚¦ãƒ³ãƒˆ

---

## ğŸ’¡ ä»Šå¾Œã®æ”¹å–„ï¼ˆè‡ªå‹•è¨˜éŒ²ï¼‰

å‹é”è¿½åŠ æ™‚ã«è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹å®Ÿè£…ã‚’è¿½åŠ ã™ã‚Œã°ã€ä»Šå¾Œã¯ç°¡å˜ã«ç¢ºèªã§ãã¾ã™ã€‚

**å®Ÿè£…æ¡ˆ**:

1. **followã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ **ï¼ˆå‰è¿°ã®ã€Œå‹é”è¿½åŠ æƒ…å ±_ç¢ºèªã¨å®Ÿè£….mdã€å‚ç…§ï¼‰

2. **friendsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**:
```sql
CREATE TABLE friends (
  user_id TEXT PRIMARY KEY,
  display_name TEXT NOT NULL,
  followed_at TEXT NOT NULL,
  is_active INTEGER DEFAULT 1
);
```

3. **çµ±è¨ˆã‚¯ã‚¨ãƒª**:
```sql
SELECT COUNT(*) FROM friends WHERE is_active = 1;
```

---

## ğŸ“ å®Ÿè¡Œä¾‹

### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
ğŸ” ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æŠ½å‡ºä¸­...
ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: /tmp/all_logs.txt

âœ… 19ä»¶ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç™ºè¦‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1/19] Ucdc6f609c888a5de55a124e70aa68d6d ã‚’å–å¾—ä¸­...
[2/19] Uca76d716e995f6377b955408bb56ce4f ã‚’å–å¾—ä¸­...
...
[19/19] Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx ã‚’å–å¾—ä¸­...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§:

âœ… å–å¾—æˆåŠŸ:

1. é˜ªå£ç¿¼
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: Ucdc6f609c888a5de55a124e70aa68d6d

2. ã•ã
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: Uca76d716e995f6377b955408bb56ce4f

3. åœ­ä¸€éƒ
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: U40f0b9af0d4941670a106848100c9fe6

4. ç”°ä¸­å¤ªéƒ
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

... (å…¨19å)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š ã‚µãƒãƒªãƒ¼:
   ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: 19å
   å–å¾—æˆåŠŸ: 17å
   å–å¾—å¤±æ•—: 2åï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ï¼‰
```

---

## ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **Raspberry Piã§å…¨ãƒ­ã‚°ã‚’çµåˆ**
2. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä¸€æ‹¬å–å¾—**
3. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ç…§åˆ**
4. **ãƒªã‚¹ãƒˆã‚’ä½œæˆ**

ã“ã®æ‰‹é †ã§19äººå…¨å“¡ã‚’ç‰¹å®šã§ãã¾ã™ï¼
