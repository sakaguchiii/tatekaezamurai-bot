# ğŸ” ã‚°ãƒ«ãƒ¼ãƒ—IDã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ç¢ºèªã™ã‚‹æ–¹æ³•

## æ–¹æ³•1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼ˆæ¨å¥¨ï¼‰

SQLiteã®JSONé–¢æ•°ã‚’ä½¿ã£ã¦ã€dataã‚«ãƒ©ãƒ ã‹ã‚‰groupNameã‚’æŠ½å‡ºï¼š

```bash
cd ~/tatekaezamurai-bot/server

sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode column

SELECT
  group_id,
  json_extract(data, '$.groupName') as group_name,
  json_extract(data, '$.createdBy.displayName') as created_by,
  datetime(created_at) as created,
  datetime(updated_at) as updated,
  status
FROM sessions
WHERE status = 'active';
EOF
```

### å‡ºåŠ›ä¾‹ï¼š
```
group_id                           group_name      created_by  created              updated              status
---------------------------------  --------------  ----------  -------------------  -------------------  ------
C47ef98c5919d7d136435d939f9fd7c99  é£²ã¿ä¼šã‚°ãƒ«ãƒ¼ãƒ—  ç”°ä¸­å¤ªéƒ    2026-01-23 15:30:00  2026-01-23 15:45:00  active
```

---

## æ–¹æ³•2: å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ç¢ºèª

activeã ã‘ã§ãªãã€ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’è¦‹ã‚‹ï¼š

```bash
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode column

SELECT
  substr(group_id, 1, 10) || '...' as group_id_short,
  json_extract(data, '$.groupName') as group_name,
  json_extract(data, '$.createdBy.displayName') as created_by,
  json_array_length(json_extract(data, '$.members')) as members,
  json_array_length(json_extract(data, '$.payments')) as payments,
  status,
  substr(created_at, 1, 10) as date
FROM sessions
ORDER BY created_at DESC
LIMIT 10;
EOF
```

---

## æ–¹æ³•3: ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—IDã®ã¿ç¢ºèª

ã‚°ãƒ«ãƒ¼ãƒ—IDãŒ `C47ef98c5919d7d136435d939f9fd7c99` ã®å ´åˆï¼š

```bash
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode line

SELECT
  group_id,
  json_extract(data, '$.groupName') as group_name,
  json_extract(data, '$.groupName') as group_name,
  json_extract(data, '$.createdBy.displayName') as created_by,
  json_extract(data, '$.createdBy.userId') as created_by_id,
  status,
  created_at,
  updated_at
FROM sessions
WHERE group_id = 'C47ef98c5919d7d136435d939f9fd7c99';
EOF
```

---

## æ–¹æ³•4: LINE APIã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«groupNameãŒç©ºã®å ´åˆã€LINE APIã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆï¼š

`server/src/scripts/check-group.ts` ã‚’ä½œæˆï¼š

```typescript
import * as line from '@line/bot-sdk';
import * as dotenv from 'dotenv';

dotenv.config();

const client = new line.messagingApi.MessagingApiClient({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN || '',
});

async function getGroupInfo(groupId: string) {
  try {
    const groupSummary = await client.getGroupSummary(groupId);
    console.log('ğŸ“Š ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±:');
    console.log(`  ã‚°ãƒ«ãƒ¼ãƒ—ID: ${groupId}`);
    console.log(`  ã‚°ãƒ«ãƒ¼ãƒ—å: ${groupSummary.groupName}`);
    console.log(`  ã‚¢ã‚¤ã‚³ãƒ³URL: ${groupSummary.pictureUrl}`);
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
    console.log('âš ï¸ ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„ã‹ã€BotãŒé€€å‡ºæ¸ˆã¿ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
  }
}

// ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’å–å¾—
const groupId = process.argv[2];
if (!groupId) {
  console.error('ä½¿ã„æ–¹: ts-node src/scripts/check-group.ts <GROUP_ID>');
  process.exit(1);
}

getGroupInfo(groupId);
```

### å®Ÿè¡Œæ–¹æ³•ï¼š

```bash
cd ~/tatekaezamurai-bot/server
ts-node src/scripts/check-group.ts C47ef98c5919d7d136435d939f9fd7c99
```

---

## ğŸ“ æ³¨æ„ç‚¹

### groupNameãŒç©ºã®å ´åˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® `groupName` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºæ–‡å­— `""` ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ä»¥ä¸‹ã®ç†ç”±ã§ç™ºç”Ÿã—ã¾ã™ï¼š

1. **åˆæœŸå®Ÿè£…ã®å•é¡Œ**: `commandHandler.ts` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã« `groupName: ''` ã¨ã—ã¦ã„ã‚‹ï¼ˆè¡Œ112ï¼‰

```typescript
const session: Session = {
  groupId,
  groupName: '',  // â† ã“ã“ãŒç©º
  createdAt: new Date().toISOString(),
  // ...
};
```

2. **LINE APIã‚’å‘¼ã‚“ã§ã„ãªã„**: ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å–å¾—ã™ã‚‹å‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„

### æ”¹å–„æ–¹æ³•

`commandHandler.ts` ã® `handleStart` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£ã—ã¦ã€ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å–å¾—ï¼š

```typescript
// ã‚°ãƒ«ãƒ¼ãƒ—ã‚µãƒãƒªãƒ¼ã‚’å–å¾—
const groupSummary = await client.getGroupSummary(groupId);

const session: Session = {
  groupId,
  groupName: groupSummary.groupName,  // â† LINE APIã‹ã‚‰å–å¾—
  createdAt: new Date().toISOString(),
  // ...
};
```

---

## ğŸ¯ ä»Šã™ãç¢ºèªã™ã‚‹æ–¹æ³•

**æ¨å¥¨ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¸€ç•ªç°¡å˜ï¼‰**:

```bash
cd ~/tatekaezamurai-bot/server
sqlite3 dist/data/database.db << 'EOF'
.headers on
.mode column
.width 35 20 15 10 10

SELECT
  group_id,
  CASE
    WHEN json_extract(data, '$.groupName') = '' THEN '(åå‰ãªã—)'
    ELSE json_extract(data, '$.groupName')
  END as group_name,
  json_extract(data, '$.createdBy.displayName') as created_by,
  json_array_length(json_extract(data, '$.members')) as members,
  status
FROM sessions
WHERE status = 'active';
EOF
```

ã“ã‚Œã§ã€activeãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆã¾ãŸã¯ä½œæˆè€…åï¼‰ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

---

## ğŸ—‘ï¸ ã‚°ãƒ«ãƒ¼ãƒ—åãŒåˆ†ã‹ã£ãŸã‚‰çµ‚äº†

```bash
# ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’ç¢ºèªï¼ˆä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§å–å¾—ï¼‰
GROUP_ID="C47ef98c5919d7d136435d939f9fd7c99"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp dist/data/database.db dist/data/database.db.backup

# ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
sqlite3 dist/data/database.db "UPDATE sessions SET status = 'completed', updated_at = datetime('now') WHERE group_id = '$GROUP_ID' AND status = 'active';"

# ç¢ºèª
sqlite3 dist/data/database.db "SELECT status, COUNT(*) FROM sessions GROUP BY status;"
```

ã¾ãŸã¯ã€å…¨ã¦ã®activeã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸€æ‹¬çµ‚äº†ï¼š

```bash
sqlite3 dist/data/database.db "UPDATE sessions SET status = 'completed', updated_at = datetime('now') WHERE status = 'active';"
```
